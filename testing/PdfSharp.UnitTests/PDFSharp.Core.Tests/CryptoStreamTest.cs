using NUnit.Framework;
using PdfSharp.Pdf;
using PdfSharp.Pdf.Internal;
using PdfSharp.Pdf.Security;
using System;
using System.Security.Cryptography;
using System.Text;

namespace PDFSharp.Core.Tests
{
    [TestFixture]
    public class CryptoStreamTest
    {
        [Test(Description ="Encrypted Stream")]
        public void DecryptStream_AESV2()
        {
            byte[] stream = {
                0x38, 0x3F, 0x40, 0x23, 0x1A, 0x5E, 0x9E, 0x0E, 0x87, 0xC2, 0x75, 0x3A, 0xA5, 0xAA, 0xD6, 0x2C,
                0xB5, 0x6B, 0x66, 0x7C, 0xFC, 0x3F, 0x19, 0xC4, 0x97, 0x4B, 0x07, 0xF7, 0xCC, 0xB3, 0x45, 0x41
            };
            var objectID = new PdfObjectID(27, 0);
            byte[] key = { 175, 214, 98, 245, 105, 125, 123, 66, 34, 231, 219, 151, 232, 0, 91, 252 };

            var iv = new byte[16];
            Array.Copy(stream, iv, 16);

            var aesV2Security = new PdfAESV2SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);
            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            var bytes = new byte[stream.Length - 16];
            var length = aesV2Security.DecryptAES(stream, 16, stream.Length - 16, bytes);

            var streamData = Encoding.UTF8.GetString(bytes, 0, length);
            Assert.IsTrue(streamData.StartsWith("q\n"));
            Assert.IsTrue(streamData.Contains("/Fm0 Do\n"));
            Assert.IsTrue(streamData.EndsWith("Q\n"));
        }

        [Test(Description = "Encrypted Stream")]
        public void EncryptStream_AESV2()
        {
            byte[] expected = {
                0x38, 0x3F, 0x40, 0x23, 0x1A, 0x5E, 0x9E, 0x0E, 0x87, 0xC2, 0x75, 0x3A, 0xA5, 0xAA, 0xD6, 0x2C,
                0xB5, 0x6B, 0x66, 0x7C, 0xFC, 0x3F, 0x19, 0xC4, 0x97, 0x4B, 0x07, 0xF7, 0xCC, 0xB3, 0x45, 0x41
            };
            var stream = "q\n/Fm0 Do\nQ\n";
            var objectID = new PdfObjectID(27, 0);
            byte[] iv = { 0x38, 0x3F, 0x40, 0x23, 0x1A, 0x5E, 0x9E, 0x0E, 0x87, 0xC2, 0x75, 0x3A, 0xA5, 0xAA, 0xD6, 0x2C };
            byte[] key = { 175, 214, 98, 245, 105, 125, 123, 66, 34, 231, 219, 151, 232, 0, 91, 252 };

            var aesV2Security = new PdfAESV2SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);
            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            var streamBytes = PdfEncoders.RawEncoding.GetBytes(stream);
            var streamLength = stream.Length % 16 == 0 ? stream.Length : ((stream.Length / 16) + 1) * 16;
            var bytes = new byte[streamLength];
            var length = aesV2Security.EncryptAES(streamBytes, 0, streamBytes.Length, bytes);

            Assert.AreEqual(streamLength, length);

            var result = new byte[bytes.Length + 16];
            Array.Copy(iv, result, 16);
            Array.Copy(bytes, 0, result, 16, bytes.Length);

            Assert.AreEqual(expected, result);
        }

        [Test(Description = "Encrypted Stream")]
        public void DecryptStream_AESV3_R5()
        {
            byte[] stream = {
                0x38, 0x3F, 0x40, 0x23, 0x1A, 0x5E, 0x9E, 0x0E, 0x87, 0xC2, 0x75, 0x3A, 0xA5, 0xAA, 0xD6, 0x2C,
                0xB5, 0x6B, 0x66, 0x7C, 0xFC, 0x3F, 0x19, 0xC4, 0x97, 0x4B, 0x07, 0xF7, 0xCC, 0xB3, 0x45, 0x41
            };
            var objectID = new PdfObjectID(27, 0);
            byte[] key = { 9, 23, 125, 89, 49, 155, 162, 71, 252, 17, 199, 43, 240, 205, 17, 120, 183, 139, 21, 2, 151, 154, 54, 68, 250, 166, 139, 21, 230, 174, 171, 125 };

            var iv = new byte[16];
            Array.Copy(stream, iv, 16);

            var aesV2Security = new PdfAESV3SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);
            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            var bytes = new byte[stream.Length - 16];
            var length = aesV2Security.DecryptAES(stream, 16, stream.Length - 16, bytes);

            var streamData = Encoding.UTF8.GetString(bytes, 0, length);
            Assert.IsTrue(streamData.StartsWith("q\n"));
            Assert.IsTrue(streamData.Contains("/Fm0 Do\n"));
            Assert.IsTrue(streamData.EndsWith("Q\n"));
        }

        [Test(Description = "Encrypted Stream")]
        public void EncryptStream_AESV3_R5()
        {
            byte[] expected = {
                0x38, 0x3F, 0x40, 0x23, 0x1A, 0x5E, 0x9E, 0x0E, 0x87, 0xC2, 0x75, 0x3A, 0xA5, 0xAA, 0xD6, 0x2C,
                0xB5, 0x6B, 0x66, 0x7C, 0xFC, 0x3F, 0x19, 0xC4, 0x97, 0x4B, 0x07, 0xF7, 0xCC, 0xB3, 0x45, 0x41
            };
            var stream = "q\n/Fm0 Do\nQ\n";
            var objectID = new PdfObjectID(27, 0);
            byte[] iv = { 0x38, 0x3F, 0x40, 0x23, 0x1A, 0x5E, 0x9E, 0x0E, 0x87, 0xC2, 0x75, 0x3A, 0xA5, 0xAA, 0xD6, 0x2C };
            byte[] key = { 9, 23, 125, 89, 49, 155, 162, 71, 252, 17, 199, 43, 240, 205, 17, 120, 183, 139, 21, 2, 151, 154, 54, 68, 250, 166, 139, 21, 230, 174, 171, 125 };

            var aesV2Security = new PdfAESV3SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);
            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            var streamBytes = PdfEncoders.RawEncoding.GetBytes(stream);
            var streamLength = stream.Length % 16 == 0 ? stream.Length : ((stream.Length / 16) + 1) * 16;
            var bytes = new byte[streamLength];
            var length = aesV2Security.EncryptAES(streamBytes, 0, streamBytes.Length, bytes);

            Assert.AreEqual(streamLength, length);

            var result = new byte[bytes.Length + 16];
            Array.Copy(iv, result, 16);
            Array.Copy(bytes, 0, result, 16, bytes.Length);

            Assert.AreEqual(expected, result);
        }

        [Test(Description = "Encrypted Metadata")]
        public void EncryptMetadata_AESV2()
        {
            byte[] stream =
            {
                60, 63, 120, 112, 97, 99, 107, 101, 116, 32, 98, 101, 103, 105, 110, 61, 34, 239, 187, 191, 34, 32, 105, 100, 61, 34, 87, 53, 77, 48, 77, 112, 67, 101, 104, 105, 72, 122, 114, 101, 83, 122, 78, 84, 99, 122, 107, 99, 57, 100, 34, 63, 62, 10, 60, 120, 58, 120, 109, 112, 109, 101, 116, 97, 32, 120, 109, 108, 110, 115, 58, 120, 61, 34, 97, 100, 111, 98, 101, 58, 110, 115, 58, 109, 101, 116, 97, 47, 34, 32, 120, 58, 120, 109, 112, 116, 107, 61, 34, 65, 100, 111, 98, 101, 32, 88, 77, 80, 32, 67, 111, 114, 101, 32, 52, 46, 50, 46, 49, 45, 99, 48, 52, 49, 32, 53, 50, 46, 51, 52, 50, 57, 57, 54, 44, 32, 50, 48, 48, 56, 47, 48, 53, 47, 48, 55, 45, 50, 49, 58, 51, 55, 58, 49, 57, 32, 32, 32, 32, 32, 32, 32, 32, 34, 62, 10, 32, 32, 32, 60, 114, 100, 102, 58, 82, 68, 70, 32, 120, 109, 108, 110, 115, 58, 114, 100, 102, 61, 34, 104, 116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 119, 51, 46, 111, 114, 103, 47, 49, 57, 57, 57, 47, 48, 50, 47, 50, 50, 45, 114, 100, 102, 45, 115, 121, 110, 116, 97, 120, 45, 110, 115, 35, 34, 62,
                10, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 120, 109, 112, 61, 34, 104, 116, 116, 112, 58, 47, 47, 110, 115, 46, 97, 100, 111, 98, 101, 46, 99, 111, 109, 47, 120, 97, 112, 47, 49, 46, 48, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 58, 77, 111, 100, 105, 102, 121, 68, 97, 116, 101, 62, 50, 48, 48, 57, 45, 48, 50, 45, 49, 53, 84, 49, 51, 58, 48, 51, 58, 49, 50, 45, 48, 56, 58, 48, 48, 60, 47, 120, 109, 112, 58, 77, 111, 100, 105, 102, 121, 68, 97, 116, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 58, 67, 114, 101, 97, 116, 101, 68, 97, 116, 101, 62, 50, 48, 48, 57, 45, 48, 50, 45, 49, 53, 84, 49, 51, 58, 48, 50, 58, 51, 53, 45, 48, 56, 58, 48, 48, 60, 47, 120, 109, 112, 58, 67, 114, 101, 97, 116, 101, 68, 97, 116, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60,
                120, 109, 112, 58, 77, 101, 116, 97, 100, 97, 116, 97, 68, 97, 116, 101, 62, 50, 48, 48, 57, 45, 48, 50, 45, 49, 53, 84, 49, 51, 58, 48, 51, 58, 49, 50, 45, 48, 56, 58, 48, 48, 60, 47, 120, 109, 112, 58, 77, 101, 116, 97, 100, 97, 116, 97, 68, 97, 116, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 58, 67, 114, 101, 97, 116, 111, 114, 84, 111, 111, 108, 62, 65, 99, 114, 111, 98, 97, 116, 32, 69, 100, 105, 116, 111, 114, 32, 57, 46, 48, 60, 47, 120, 109, 112, 58, 67, 114, 101, 97, 116, 111, 114, 84, 111, 111, 108, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62, 10, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 100, 99, 61, 34, 104, 116, 116, 112, 58, 47, 47, 112, 117, 114, 108, 46, 111, 114, 103, 47, 100, 99, 47, 101, 108, 101, 109,
                101, 110, 116, 115, 47, 49, 46, 49, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 100, 99, 58, 102, 111, 114, 109, 97, 116, 62, 97, 112, 112, 108, 105, 99, 97, 116, 105, 111, 110, 47, 112, 100, 102, 60, 47, 100, 99, 58, 102, 111, 114, 109, 97, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 100, 99, 58, 116, 105, 116, 108, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 65, 108, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 108, 105, 32, 120, 109, 108, 58, 108, 97, 110, 103, 61, 34, 120, 45, 100, 101, 102, 97, 117, 108, 116, 34, 62, 85, 110, 116, 105, 116, 108, 101, 100, 60, 47, 114, 100, 102, 58, 108, 105, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 65, 108, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 47, 100, 99, 58, 116, 105, 116, 108, 101, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62, 10, 32,
                32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 120, 109, 112, 77, 77, 61, 34, 104, 116, 116, 112, 58, 47, 47, 110, 115, 46, 97, 100, 111, 98, 101, 46, 99, 111, 109, 47, 120, 97, 112, 47, 49, 46, 48, 47, 109, 109, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 77, 77, 58, 68, 111, 99, 117, 109, 101, 110, 116, 73, 68, 62, 117, 117, 105, 100, 58, 57, 99, 49, 98, 98, 56, 57, 50, 45, 56, 50, 53, 52, 45, 101, 102, 52, 57, 45, 57, 100, 57, 51, 45, 48, 54, 52, 48, 50, 54, 51, 55, 53, 51, 50, 56, 60, 47, 120, 109, 112, 77, 77, 58, 68, 111, 99, 117, 109, 101, 110, 116, 73, 68, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 77, 77, 58, 73, 110, 115, 116, 97, 110, 99, 101, 73, 68, 62, 117, 117, 105, 100, 58, 50, 51, 101, 53, 50, 48, 55, 100, 45, 57, 48, 48, 51, 45, 57, 49, 52, 48, 45, 98, 101, 53,
                54, 45, 50, 51, 55, 102, 52, 54, 101, 97, 98, 53, 100, 101, 60, 47, 120, 109, 112, 77, 77, 58, 73, 110, 115, 116, 97, 110, 99, 101, 73, 68, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62, 10, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 112, 100, 102, 61, 34, 104, 116, 116, 112, 58, 47, 47, 110, 115, 46, 97, 100, 111, 98, 101, 46, 99, 111, 109, 47, 112, 100, 102, 47, 49, 46, 51, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 112, 100, 102, 58, 80, 114, 111, 100, 117, 99, 101, 114, 62, 65, 100, 111, 98, 101, 32, 65, 99, 114, 111, 98, 97, 116, 32, 57, 46, 48, 46, 48, 60, 47, 112, 100, 102, 58, 80, 114, 111, 100, 117, 99, 101, 114, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62,
                10, 32, 32, 32, 60, 47, 114, 100, 102, 58, 82, 68, 70, 62, 10, 60, 47, 120, 58, 120, 109, 112, 109, 101, 116, 97, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 60, 63, 120, 112, 97, 99, 107, 101, 116, 32, 101, 110, 100, 61, 34, 119, 34, 63, 62
            };
            byte[] expected =
            {
                222, 119, 34, 60, 88, 17, 111, 37, 188, 58, 229, 82, 179, 219, 175, 18, 17, 30, 209, 11, 38, 28, 154, 115, 190, 236, 9, 76, 248, 187, 192, 197, 45, 42, 59, 45, 14, 201, 31, 130, 174, 36, 90, 53, 78, 171, 241, 244, 184, 156, 174, 41, 155, 95, 9, 156, 253, 6, 124, 131, 122, 239, 255, 251, 112, 2, 186, 250, 197, 83, 43, 62, 147, 187, 230, 6, 98, 128, 11, 100, 218, 109, 91, 173, 66, 145, 90, 250, 202, 168, 233, 226, 19, 211, 175, 143, 35, 222, 82, 194, 153, 87, 183, 106, 16, 80, 203, 117, 238, 89, 153, 85, 94, 238, 111, 159, 225, 106, 218, 65, 241, 196, 13, 134, 0, 27, 98, 237, 96, 127, 192, 111, 63, 23, 131, 23, 37, 75, 144, 137, 175, 103, 231, 236, 175, 38, 209, 91, 35, 40, 110, 153, 73, 71, 156, 119, 218, 121, 12, 75, 228, 130, 147, 97, 68, 171, 42, 74, 191, 142, 143, 226, 87, 35, 231, 137, 121, 227, 105, 252, 123, 20, 159, 138, 71, 132, 96, 200, 224, 6, 77, 76, 179, 169, 201, 165, 118, 222, 104, 118, 76, 152, 41, 24, 234, 102, 221, 82, 86, 170, 9, 5, 107, 232, 225, 243, 98, 100, 79, 142, 116, 127, 70, 239, 74,
                204, 143, 52, 140, 247, 71, 171, 94, 68, 124, 122, 182, 103, 136, 88, 218, 189, 28, 211, 62, 13, 16, 112, 69, 174, 207, 229, 248, 241, 46, 247, 76, 106, 243, 245, 72, 134, 160, 235, 176, 43, 170, 18, 44, 37, 121, 142, 6, 226, 72, 252, 139, 211, 108, 38, 90, 183, 199, 160, 228, 139, 178, 125, 231, 194, 31, 122, 4, 133, 89, 13, 116, 249, 48, 126, 239, 59, 168, 28, 70, 234, 80, 1, 218, 98, 168, 40, 158, 118, 201, 241, 176, 44, 65, 175, 238, 160, 133, 133, 212, 160, 118, 65, 54, 211, 31, 186, 230, 115, 53, 143, 13, 19, 20, 89, 12, 79, 205, 141, 145, 216, 178, 132, 202, 54, 213, 32, 219, 95, 226, 230, 73, 60, 237, 30, 24, 192, 44, 183, 53, 154, 183, 159, 9, 222, 115, 157, 190, 79, 202, 216, 171, 35, 25, 144, 44, 13, 14, 216, 187, 239, 108, 42, 152, 132, 238, 180, 176, 220, 238, 78, 95, 21, 40, 68, 188, 188, 42, 183, 155, 217, 191, 122, 42, 153, 117, 122, 36, 98, 190, 128, 127, 3, 78, 120, 59, 205, 220, 64, 243, 92, 238, 74, 41, 211, 123, 49, 7, 100, 220, 32, 170, 194, 223, 167, 46, 193, 194, 232, 141, 201, 204, 135,
                149, 97, 140, 112, 194, 121, 100, 23, 26, 215, 244, 36, 77, 18, 44, 2, 175, 31, 168, 19, 46, 51, 242, 140, 100, 64, 129, 157, 168, 253, 69, 53, 23, 217, 204, 226, 4, 59, 71, 202, 0, 224, 6, 246, 12, 68, 19, 196, 15, 196, 106, 25, 30, 143, 133, 207, 51, 63, 50, 143, 141, 128, 9, 217, 79, 133, 57, 20, 120, 58, 118, 119, 246, 45, 74, 107, 102, 145, 210, 189, 164, 20, 61, 93, 248, 42, 7, 159, 229, 224, 90, 204, 73, 94, 135, 84, 185, 187, 163, 122, 170, 36, 14, 125, 67, 72, 187, 67, 144, 35, 145, 29, 52, 203, 75, 110, 219, 176, 224, 254, 22, 241, 67, 96, 175, 124, 120, 241, 103, 146, 227, 118, 9, 90, 19, 141, 51, 111, 47, 239, 126, 228, 218, 80, 141, 205, 236, 27, 238, 227, 173, 9, 217, 119, 234, 40, 83, 233, 181, 36, 25, 103, 59, 41, 27, 210, 87, 173, 166, 234, 204, 145, 81, 141, 194, 233, 65, 223, 188, 16, 124, 249, 184, 159, 154, 102, 87, 144, 57, 187, 10, 204, 74, 104, 23, 104, 182, 245, 167, 9, 23, 204, 60, 36, 226, 108, 5, 86, 240, 104, 215, 22, 31, 134, 209, 253, 79, 170, 156, 140, 139, 76, 107, 133, 219, 0,
                110, 101, 152, 65, 24, 157, 40, 62, 87, 78, 124, 196, 125, 214, 19, 184, 44, 42, 101, 232, 12, 165, 247, 189, 254, 57, 231, 29, 105, 144, 101, 181, 251, 155, 110, 238, 30, 252, 133, 186, 174, 17, 220, 22, 82, 219, 174, 55, 76, 102, 120, 145, 223, 1, 65, 178, 245, 0, 172, 69, 212, 111, 132, 72, 186, 23, 48, 0, 192, 181, 162, 71, 91, 163, 116, 243, 69, 184, 25, 131, 37, 172, 71, 192, 117, 163, 130, 204, 86, 115, 107, 237, 226, 139, 157, 17, 49, 94, 213, 223, 125, 179, 231, 178, 172, 148, 11, 57, 46, 140, 137, 13, 250, 91, 66, 41, 109, 143, 158, 30, 116, 103, 177, 33, 194, 200, 181, 13, 35, 47, 109, 23, 96, 139, 108, 232, 60, 35, 231, 66, 72, 20, 164, 92, 79, 70, 124, 253, 132, 43, 187, 201, 105, 202, 168, 108, 11, 140, 249, 223, 128, 22, 125, 129, 96, 18, 59, 252, 83, 112, 46, 36, 91, 160, 192, 245, 252, 37, 250, 26, 217, 88, 251, 110, 192, 222, 229, 63, 35, 63, 227, 90, 31, 189, 163, 197, 125, 162, 35, 248, 105, 55, 224, 225, 211, 209, 83, 66, 0, 192, 108, 209, 177, 184, 106, 188, 110, 202, 224, 180, 154, 116,
                159, 209, 222, 81, 30, 148, 210, 17, 253, 170, 97, 65, 78, 152, 33, 57, 112, 177, 71, 185, 23, 216, 135, 252, 66, 196, 243, 227, 111, 132, 211, 7, 203, 143, 155, 109, 232, 212, 40, 26, 154, 203, 65, 73, 140, 202, 235, 19, 32, 94, 143, 48, 223, 86, 44, 205, 108, 11, 117, 112, 198, 203, 45, 246, 229, 69, 237, 117, 88, 51, 188, 22, 99, 42, 24, 219, 174, 168, 155, 69, 203, 143, 118, 154, 219, 239, 147, 64, 220, 189, 27, 158, 3, 25, 107, 72, 189, 20, 182, 161, 168, 232, 90, 14, 208, 142, 208, 61, 173, 156, 33, 180, 153, 189, 220, 114, 128, 17, 151, 77, 57, 173, 56, 1, 2, 239, 20, 244, 222, 85, 130, 114, 64, 43, 185, 193, 74, 40, 61, 15, 65, 44, 126, 33, 171, 204, 41, 65, 252, 79, 104, 175, 117, 186, 25, 120, 172, 247, 22, 150, 186, 97, 164, 137, 55, 144, 113, 217, 211, 16, 217, 133, 250, 77, 65, 89, 105, 28, 94, 194, 127, 214, 32, 253, 131, 91, 123, 27, 255, 146, 81, 107, 178, 249, 174, 233, 19, 130, 92, 231, 250, 122, 144, 0, 224, 164, 209, 183, 205, 180, 210, 161, 7, 193, 198, 189, 122, 86, 121, 29, 211, 33, 52,
                253, 173, 140, 22, 34, 174, 229, 188, 83, 226, 154, 49, 115, 153, 105, 91, 15, 14, 173, 250, 193, 23, 174, 227, 17, 250, 224, 140, 84, 100, 102, 222, 19, 45, 50, 162, 242, 122, 108, 153, 70, 172, 102, 219, 220, 212, 173, 129, 200, 252, 225, 19, 92, 16, 147, 54, 37, 103, 52, 197, 57, 216, 63, 108, 246, 227, 52, 32, 84, 125, 42, 15, 78, 193, 33, 123, 220, 43, 213, 226, 126, 161, 145, 3, 11, 43, 14, 200, 48, 201, 117, 255, 20, 43, 188, 240, 133, 182, 95, 183, 160, 199, 14, 130, 43, 252, 240, 243, 87, 49, 47, 254, 223, 211, 113, 96, 202, 160, 64, 174, 196, 142, 108, 195, 76, 232, 59, 143, 188, 159, 50, 68, 177, 223, 215, 148, 221, 113, 117, 121, 159, 75, 153, 76, 31, 133, 3, 108, 165, 10, 115, 149, 158, 164, 217, 170, 232, 220, 186, 21, 181, 83, 214, 108, 33, 95, 205, 78, 72, 172, 57, 177, 143, 221, 154, 215, 217, 36, 39, 236, 190, 240, 143, 187, 93, 58, 7, 239, 176, 221, 48, 169, 25, 207, 240, 189, 50, 161, 236, 87, 137, 36, 155, 84, 160, 79, 13, 218, 65, 136, 101, 209, 7, 41, 194, 56, 76, 127, 236, 192, 154, 82,
                147, 110, 39, 104, 208, 195, 239, 177, 236, 92, 33, 237, 254, 83, 173, 52, 15, 34, 98, 85, 52, 192, 73, 59, 250, 28, 70, 128, 160, 236, 70, 236, 18, 143, 128, 187, 143, 165, 181, 144, 124, 64, 175, 63, 113, 245, 38, 146, 114, 130, 173, 94, 87, 101, 9, 162, 84, 174, 94, 237, 62, 53, 157, 211, 99, 102, 228, 68, 113, 94, 237, 45, 236, 172, 222, 10, 198, 104, 222, 212, 240, 32, 55, 43, 234, 54, 118, 184, 240, 16, 224, 26, 146, 204, 248, 205, 110, 134, 255, 154, 34, 38, 250, 156, 46, 203, 46, 211, 116, 220, 74, 73, 249, 167, 172, 65, 166, 166, 255, 147, 133, 66, 121, 134, 44, 45, 56, 122, 222, 54, 115, 182, 123, 110, 175, 44, 168, 133, 205, 13, 144, 114, 214, 235, 2, 93, 246, 134, 198, 233, 164, 134, 241, 254, 82, 58, 237, 179, 185, 134, 231, 201, 164, 28, 254, 12, 91, 28, 68, 243, 91, 235, 15, 200, 64, 165, 222, 36, 211, 135, 31, 250, 252, 84, 83, 49, 115, 47, 234, 53, 249, 55, 192, 106, 34, 74, 67, 206, 222, 33, 170, 127, 189, 252, 81, 203, 255, 250, 211, 41, 199, 185, 242, 1, 215, 24, 190, 98, 103, 126, 205, 13,
                203, 85, 144, 177, 159, 156, 35, 133, 85, 209, 2, 152, 55, 253, 82, 76, 25, 31, 161, 94, 154, 169, 255, 9, 148, 114, 231, 161, 236, 103, 25, 166, 118, 138, 220, 128, 224, 61, 143, 219, 85, 231, 231, 12, 227, 146, 200, 158, 112, 47, 92, 26, 207, 106, 124, 233, 160, 161, 224, 19, 113, 199, 186, 205, 237, 5, 172, 146, 128, 185, 168, 136, 89, 74, 149, 35, 173, 209, 72, 19, 122, 33, 254, 123, 132, 186, 188, 213, 142, 31, 176, 79, 255, 54, 68, 135, 240, 20, 40, 32, 210, 178, 241, 168, 233, 39, 35, 187, 5, 63, 27, 161, 61, 143, 91, 120, 8, 228, 184, 89, 175, 218, 213, 131, 66, 137, 36, 2, 93, 4, 22, 235, 181, 226, 210, 60, 99, 202, 158, 151, 191, 162, 131, 156, 17, 114, 206, 97, 99, 81, 169, 6, 66, 243, 228, 69, 156, 27, 155, 61, 209, 127, 140, 24, 232, 214, 0, 37, 208, 161, 36, 197, 155, 240, 156, 63, 210, 77, 15, 202, 115, 9, 4, 184, 110, 200, 144, 17, 82, 249, 253, 110, 149, 98, 92, 37, 63, 239, 165, 132, 144, 234, 243, 80, 108, 87, 30, 132, 132, 85, 241, 173, 118, 47, 104, 178, 35, 0, 252, 178, 223, 228, 134, 27,
                36, 195, 23, 183, 117, 250, 131, 209, 170, 163, 204, 78, 234, 177, 13, 77, 132, 27, 201, 40, 247, 129, 65, 70, 47, 220, 78, 66, 113, 223, 248, 55, 251, 65, 146, 96, 139, 144, 22, 9, 165, 212, 140, 173, 60, 193, 81, 203, 106, 175, 215, 120, 35, 186, 10, 82, 249, 112, 183, 252, 90, 125, 175, 8, 80, 55, 136, 246, 1, 42, 134, 106, 217, 182, 101, 125, 206, 53, 192, 143, 135, 239, 71, 159, 28, 107, 50, 124, 70, 150, 176, 188, 34, 81, 217, 219, 6, 148, 186, 204, 214, 65, 19, 89, 222, 10, 162, 78, 239, 138, 220, 3, 52, 16, 197, 127, 84, 105, 144, 34, 145, 103, 176, 199, 58, 6, 169, 8, 83, 235, 232, 181, 105, 146, 251, 162, 133, 127, 187, 213, 120, 56, 225, 38, 102, 12, 47, 168, 207, 102, 57, 48, 181, 230, 106, 106, 220, 56, 200, 31, 157, 80, 236, 60, 138, 130, 220, 187, 54, 230, 157, 146, 194, 143, 155, 14, 245, 40, 29, 152, 2, 87, 201, 131, 133, 150, 104, 74, 157, 69, 228, 151, 78, 52, 188, 89, 6, 114, 201, 149, 74, 95, 49, 157, 190, 246, 0, 62, 39, 52, 168, 179, 83, 64, 147, 155, 189, 201, 81, 34, 243, 204,89, 232,
                145, 234, 191, 173, 170, 242, 54, 72, 24, 166, 213, 130, 185, 115, 235, 84, 192, 4, 246, 162, 77, 47, 115, 23, 42, 145, 59, 123, 232, 227, 239, 58, 243, 114, 41, 252, 244, 39, 83, 74, 124, 140, 94, 237, 232, 129, 100, 9, 126, 78, 86, 194, 44, 253, 2, 132, 17, 68, 237, 4, 206, 121, 236, 253, 80, 118, 122, 106, 177, 80, 160, 60, 87, 18, 133, 2, 163, 176, 212, 9, 140, 230, 61, 212, 203, 97, 223, 213, 223, 240, 145, 201, 130, 253, 184, 232, 218, 5, 161, 201, 39, 126, 40, 97, 40, 41, 236, 6, 102, 240, 5, 234, 43, 168, 227, 231, 120, 92, 190, 248, 120, 136, 22, 125, 180, 216, 235, 199, 51, 46, 19, 219, 229, 81, 19, 147, 166, 107, 33, 30, 100, 193, 210, 230, 140, 50, 161, 242, 211, 236, 95, 134, 169, 235, 65, 154, 95, 159, 34, 225, 96, 224, 170, 182, 244, 169, 83, 106, 246, 182, 140, 108, 70, 70, 232, 39, 170, 240, 82, 131, 106, 6, 87, 58, 121, 102, 148, 188, 155, 40, 102, 245, 49, 54, 43, 37, 28, 163, 122, 242, 236, 202, 230, 137, 23, 7, 58, 236, 117, 122, 179, 6, 140, 222, 233, 16, 117, 3, 232, 228, 58, 115, 191,
                12, 66, 158, 111, 17, 157, 45, 63, 146, 86, 45, 64, 31, 86, 10, 75, 127, 62, 82, 82, 240, 38, 230, 227, 192, 193, 245, 74, 235, 163, 195, 80, 91, 212, 35, 216, 27, 73, 25, 151, 234, 130, 117, 168, 206, 216, 174, 120, 29, 72, 254, 2, 48, 192, 84, 249, 13, 45, 8, 94, 250, 47, 182, 98, 244, 247, 166, 149, 216, 253, 184, 127, 142, 246, 219, 201, 14, 227, 87, 6, 184, 191, 219, 180, 104, 150, 150, 150, 66, 94, 9, 244, 99, 133, 47, 61, 23, 200, 138, 247, 127, 241, 207, 117, 89, 59, 68, 108, 92, 9, 168, 118, 235, 179, 133, 191, 225, 180, 246, 55, 23, 174, 138, 93, 40, 93, 183, 185, 149, 234, 203, 200, 1, 188, 80, 250, 93, 2, 75, 144, 33, 23, 87, 130, 62, 58, 33, 139, 120, 95, 126, 38, 56, 14, 112, 128, 145, 60, 218, 200, 213, 20, 212, 227, 167, 141, 44, 15, 144, 199, 189, 148, 245, 150, 118, 238, 103, 114, 135, 233, 254, 57, 109, 253, 197, 171, 222, 135, 8, 238, 245, 217, 255, 55, 164, 224, 48, 11, 156, 142, 23, 162, 121, 214, 69, 185, 247, 57, 52, 241, 75, 25, 7, 92, 163, 44, 158, 178, 65, 240, 69, 229, 105, 231, 51,
                185, 230, 75, 73, 191, 125, 116, 196, 251, 174, 33, 104, 2, 251, 54, 48, 83, 161, 97, 57, 103, 25, 208, 238, 69, 236, 184, 69, 174, 192, 151, 171, 215, 119, 185, 249, 27, 164, 52, 25, 20, 150, 82, 145, 221, 45, 151, 15, 25, 109, 191, 226, 144, 74, 39, 78, 74, 39, 32, 234, 40, 121, 41, 129, 205, 64, 45, 225, 114, 227, 9, 120, 246, 190, 21, 209, 98, 44, 241, 213, 147, 196, 117, 29, 244, 227, 48, 213, 193, 212, 30, 185, 179, 139, 173, 165, 148, 201, 48, 149, 100, 122, 13, 99, 186, 69, 2, 170, 192, 13, 177, 72, 7, 191, 169, 66, 124, 190, 53, 195, 68, 202, 112, 67, 60, 185, 55, 95, 191, 76, 183, 81, 36, 16, 118, 59, 206, 94, 141, 65, 199, 208, 203, 86, 151, 135, 39, 180, 157, 164, 4, 17, 85, 146, 82, 60, 121, 238, 76, 33, 24, 87, 25, 37, 29, 173, 159, 51, 60, 228, 95, 103, 249, 155, 61, 89, 148, 179, 121, 109, 27, 219, 74, 57, 10, 152, 6, 227, 49, 26, 116, 77, 250, 178, 127, 70, 205, 0, 226, 223, 56, 120, 6, 161, 4, 62, 35, 111, 63, 235, 190, 79, 110, 17, 189, 36, 94, 213, 39, 53, 222, 252, 79, 86, 145, 29, 231,
                188, 70, 82, 64, 218, 175, 65, 128, 162, 74, 129, 141, 162, 72, 179, 42, 143, 102, 4, 158, 92, 146, 224, 38, 248, 226, 73, 177, 226, 84, 71, 249, 8, 101, 106, 234, 59, 215, 115, 36, 229, 146, 203, 123, 62, 100, 143, 104, 174, 158, 146, 95, 66, 190, 48, 100, 19, 74, 157, 1, 204, 184, 194, 130, 182, 231, 172, 19, 140, 40, 130, 2, 117, 58, 200, 109, 36, 167, 117, 24, 42, 43, 216, 198, 63, 255, 141, 219, 246, 178, 95, 121, 253, 161, 92, 138, 145, 18, 177, 250, 94, 2, 204, 81, 33, 109, 251, 9, 17, 188, 194, 58, 107, 126, 184, 168, 103, 85, 212, 55, 104, 152, 18, 53, 71, 22, 249, 104, 219, 95, 29, 81, 118, 233, 160, 99, 151, 94, 232, 149, 221, 181, 97, 67, 94, 26, 89, 89, 213, 10, 65, 108, 141, 23, 238, 46, 36, 159, 39, 97, 49, 110, 159, 147, 129, 4, 121, 155, 6, 170, 85, 86, 145, 121, 132, 139, 162, 166, 144, 238, 120, 220, 181, 3, 238, 245, 145, 177, 159, 72, 87, 78, 207, 249, 165, 249, 227, 40, 108, 195, 76, 234, 244, 125, 139, 176, 141, 185, 134, 81, 137, 62, 94, 104, 16, 206, 230, 237, 220, 79, 194, 9, 242, 37,
                201, 110, 55, 193, 162, 140, 132, 9, 38, 178, 236, 21, 61, 202, 153, 249, 79, 57, 95, 173, 105, 209, 155, 214, 41, 214, 62, 149, 246, 17, 51, 149, 11, 107, 250, 121, 21, 189, 231, 248, 49, 143, 159, 118, 201, 90, 109, 159, 125, 80, 192, 31, 171, 32, 239, 220, 154, 61, 221, 166, 60, 202, 197, 11, 200, 123, 252, 36, 136, 211, 207, 51, 223, 2, 194, 49, 183, 1, 99, 35, 230, 225, 77, 108, 149, 38, 227, 33, 224, 102, 20, 66, 240, 64, 208, 216, 174, 225, 112, 18, 153, 188, 248, 254, 145, 232, 55, 143, 65, 158, 77, 81, 209, 66, 172, 50, 48, 20, 119, 74, 242, 57, 6, 101, 7, 4, 225, 205, 255, 235, 71, 82, 180, 106, 30, 190, 146, 186, 82, 217, 59, 181, 138, 150, 61, 112, 154, 137, 106, 202, 37, 147, 160, 108, 64, 193, 225, 129, 241, 188, 182, 210, 11, 28, 164, 69, 248, 167, 139, 187, 37, 70, 209, 87, 243, 37, 61, 139, 10, 154, 174, 164, 173, 141, 142, 244, 254, 217, 149, 194, 84, 161, 248, 117, 130, 104, 119, 144, 77, 36, 170, 75, 18, 129, 15, 16, 147, 107, 219, 42, 43, 144, 155, 17, 39, 128, 78, 207, 231, 151, 36, 98,
                23, 84, 73, 55, 46, 166, 76, 88, 156, 143, 126, 61, 220, 92, 173, 210, 39, 153, 22, 216, 126, 206, 114, 127, 206, 178, 120, 29, 244, 29, 254, 145, 72, 10, 126, 87, 232, 138, 222, 127, 204, 76, 142, 53, 65, 29, 139, 213, 158, 150, 114, 214, 142, 38, 146, 203, 203, 89, 159, 211, 96, 41, 219, 28, 254, 248, 64, 232, 161, 68, 105, 228, 79, 22, 193, 198, 2, 65, 182, 150, 33, 78, 214, 243, 43, 255, 241, 16, 119, 145, 73, 60, 108, 71, 140, 123, 87, 25, 44, 160, 31, 36, 173, 20, 99, 81, 130, 246, 128, 157, 90, 198, 106, 13, 236, 64, 232, 98, 198, 101, 133, 234, 17, 140, 32, 35, 185, 166, 27, 182, 198, 227, 118, 99, 94, 59, 140, 17, 210, 18, 99, 185, 185, 44, 194, 8, 30, 80, 247, 32, 146, 253, 20, 138, 18, 170, 100, 175, 164, 236, 245, 107, 63, 167, 193, 165, 61, 84, 27, 157, 22, 18, 162, 49, 42, 26, 218, 152, 225, 131, 246, 63, 153, 116, 196, 58, 192, 24, 197, 154, 218, 110, 96, 127, 196, 246, 237, 233, 219, 190, 237, 249, 127, 148, 107, 147, 107, 237, 135, 132, 120, 72, 154, 124, 88, 174, 218, 72, 156, 42, 136, 237,
                74, 183, 208, 155, 193, 199, 29, 83, 62, 212, 21, 171, 186, 200, 202, 185, 32, 250, 20, 21, 51, 7, 80, 154, 17, 219, 86, 195, 61, 78, 4, 221, 240, 80, 198, 159, 127, 105, 89, 39, 165, 221, 66, 95, 85, 57, 7, 40, 79, 119, 36, 39, 64, 140, 197, 208, 198, 2, 30, 191, 134, 52, 246, 207, 62, 139, 243, 228, 99, 236, 76, 33, 107, 223, 231, 231, 35, 213, 132, 131, 140, 65, 195, 181, 175, 69, 130, 108, 180, 101, 48, 65, 32, 84, 17, 72, 3, 203, 152, 101, 176, 170, 124, 23, 36, 109, 188, 104, 176, 76, 220, 191, 78, 12, 150, 82, 220, 19, 141, 185, 156, 41, 116, 218, 108, 89, 118, 144, 104, 14, 41, 229, 12, 212, 203, 79, 93, 32, 232, 183, 168, 0, 137, 60, 62, 212, 19, 222, 83, 196, 35, 80, 188, 253, 116, 81, 31, 20, 235, 137, 39, 224, 202, 135, 244, 146
            };
            var objectID = new PdfObjectID(2, 0);
            byte[] key = { 175, 214, 98, 245, 105, 125, 123, 66, 34, 231, 219, 151, 232, 0, 91, 252 };
            byte[] iv = { 222, 119, 34, 60, 88, 17, 111, 37, 188, 58, 229, 82, 179, 219, 175, 18 };

            var xml = Encoding.UTF8.GetString(stream);
            Assert.IsTrue(xml.StartsWith("<?xpacket begin="));
            Assert.IsTrue(xml.Contains("W5M0MpCehiHzreSzNTczkc9d"));
            Assert.IsTrue(xml.EndsWith("?>"));

            var aesV2Security = new PdfAESV2SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);

            byte[] expectedKey = { 113, 242, 77, 59, 208, 229, 249, 224, 156, 108, 169, 255, 240, 34, 101, 158 };
            Assert.AreEqual(expectedKey, aesV2Security._key);

            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            var streamLength = stream.Length % 16 == 0 ? stream.Length : ((stream.Length / 16) + 1) * 16;
            var bytes = new byte[streamLength];
            var length = aesV2Security.EncryptAES(stream, 0, stream.Length, bytes);

            Assert.AreEqual(streamLength, length);

            var result = new byte[bytes.Length + 16];
            Array.Copy(iv, result, 16);
            Array.Copy(bytes, 0, result, 16, bytes.Length);

            Assert.AreEqual(expected, result);  
        }

        [Test(Description = "Encrypted Metadata")]
        public void DecryptMetadata_AESV2()
        {
            byte[] stream =
            {
                222, 119, 34, 60, 88, 17, 111, 37, 188, 58, 229, 82, 179, 219, 175, 18, 17, 30, 209, 11, 38, 28, 154, 115, 190, 236, 9, 76, 248, 187, 192, 197, 45, 42, 59, 45, 14, 201, 31, 130, 174, 36, 90, 53, 78, 171, 241, 244, 184, 156, 174, 41, 155, 95, 9, 156, 253, 6, 124, 131, 122, 239, 255, 251, 112, 2, 186, 250, 197, 83, 43, 62, 147, 187, 230, 6, 98, 128, 11, 100, 218, 109, 91, 173, 66, 145, 90, 250, 202, 168, 233, 226, 19, 211, 175, 143, 35, 222, 82, 194, 153, 87, 183, 106, 16, 80, 203, 117, 238, 89, 153, 85, 94, 238, 111, 159, 225, 106, 218, 65, 241, 196, 13, 134, 0, 27, 98, 237, 96, 127, 192, 111, 63, 23, 131, 23, 37, 75, 144, 137, 175, 103, 231, 236, 175, 38, 209, 91, 35, 40, 110, 153, 73, 71, 156, 119, 218, 121, 12, 75, 228, 130, 147, 97, 68, 171, 42, 74, 191, 142, 143, 226, 87, 35, 231, 137, 121, 227, 105, 252, 123, 20, 159, 138, 71, 132, 96, 200, 224, 6, 77, 76, 179, 169, 201, 165, 118, 222, 104, 118, 76, 152, 41, 24, 234, 102, 221, 82, 86, 170, 9, 5, 107, 232, 225, 243, 98, 100, 79, 142, 116, 127, 70, 239, 74,
                204, 143, 52, 140, 247, 71, 171, 94, 68, 124, 122, 182, 103, 136, 88, 218, 189, 28, 211, 62, 13, 16, 112, 69, 174, 207, 229, 248, 241, 46, 247, 76, 106, 243, 245, 72, 134, 160, 235, 176, 43, 170, 18, 44, 37, 121, 142, 6, 226, 72, 252, 139, 211, 108, 38, 90, 183, 199, 160, 228, 139, 178, 125, 231, 194, 31, 122, 4, 133, 89, 13, 116, 249, 48, 126, 239, 59, 168, 28, 70, 234, 80, 1, 218, 98, 168, 40, 158, 118, 201, 241, 176, 44, 65, 175, 238, 160, 133, 133, 212, 160, 118, 65, 54, 211, 31, 186, 230, 115, 53, 143, 13, 19, 20, 89, 12, 79, 205, 141, 145, 216, 178, 132, 202, 54, 213, 32, 219, 95, 226, 230, 73, 60, 237, 30, 24, 192, 44, 183, 53, 154, 183, 159, 9, 222, 115, 157, 190, 79, 202, 216, 171, 35, 25, 144, 44, 13, 14, 216, 187, 239, 108, 42, 152, 132, 238, 180, 176, 220, 238, 78, 95, 21, 40, 68, 188, 188, 42, 183, 155, 217, 191, 122, 42, 153, 117, 122, 36, 98, 190, 128, 127, 3, 78, 120, 59, 205, 220, 64, 243, 92, 238, 74, 41, 211, 123, 49, 7, 100, 220, 32, 170, 194, 223, 167, 46, 193, 194, 232, 141, 201, 204, 135,
                149, 97, 140, 112, 194, 121, 100, 23, 26, 215, 244, 36, 77, 18, 44, 2, 175, 31, 168, 19, 46, 51, 242, 140, 100, 64, 129, 157, 168, 253, 69, 53, 23, 217, 204, 226, 4, 59, 71, 202, 0, 224, 6, 246, 12, 68, 19, 196, 15, 196, 106, 25, 30, 143, 133, 207, 51, 63, 50, 143, 141, 128, 9, 217, 79, 133, 57, 20, 120, 58, 118, 119, 246, 45, 74, 107, 102, 145, 210, 189, 164, 20, 61, 93, 248, 42, 7, 159, 229, 224, 90, 204, 73, 94, 135, 84, 185, 187, 163, 122, 170, 36, 14, 125, 67, 72, 187, 67, 144, 35, 145, 29, 52, 203, 75, 110, 219, 176, 224, 254, 22, 241, 67, 96, 175, 124, 120, 241, 103, 146, 227, 118, 9, 90, 19, 141, 51, 111, 47, 239, 126, 228, 218, 80, 141, 205, 236, 27, 238, 227, 173, 9, 217, 119, 234, 40, 83, 233, 181, 36, 25, 103, 59, 41, 27, 210, 87, 173, 166, 234, 204, 145, 81, 141, 194, 233, 65, 223, 188, 16, 124, 249, 184, 159, 154, 102, 87, 144, 57, 187, 10, 204, 74, 104, 23, 104, 182, 245, 167, 9, 23, 204, 60, 36, 226, 108, 5, 86, 240, 104, 215, 22, 31, 134, 209, 253, 79, 170, 156, 140, 139, 76, 107, 133, 219, 0,
                110, 101, 152, 65, 24, 157, 40, 62, 87, 78, 124, 196, 125, 214, 19, 184, 44, 42, 101, 232, 12, 165, 247, 189, 254, 57, 231, 29, 105, 144, 101, 181, 251, 155, 110, 238, 30, 252, 133, 186, 174, 17, 220, 22, 82, 219, 174, 55, 76, 102, 120, 145, 223, 1, 65, 178, 245, 0, 172, 69, 212, 111, 132, 72, 186, 23, 48, 0, 192, 181, 162, 71, 91, 163, 116, 243, 69, 184, 25, 131, 37, 172, 71, 192, 117, 163, 130, 204, 86, 115, 107, 237, 226, 139, 157, 17, 49, 94, 213, 223, 125, 179, 231, 178, 172, 148, 11, 57, 46, 140, 137, 13, 250, 91, 66, 41, 109, 143, 158, 30, 116, 103, 177, 33, 194, 200, 181, 13, 35, 47, 109, 23, 96, 139, 108, 232, 60, 35, 231, 66, 72, 20, 164, 92, 79, 70, 124, 253, 132, 43, 187, 201, 105, 202, 168, 108, 11, 140, 249, 223, 128, 22, 125, 129, 96, 18, 59, 252, 83, 112, 46, 36, 91, 160, 192, 245, 252, 37, 250, 26, 217, 88, 251, 110, 192, 222, 229, 63, 35, 63, 227, 90, 31, 189, 163, 197, 125, 162, 35, 248, 105, 55, 224, 225, 211, 209, 83, 66, 0, 192, 108, 209, 177, 184, 106, 188, 110, 202, 224, 180, 154, 116,
                159, 209, 222, 81, 30, 148, 210, 17, 253, 170, 97, 65, 78, 152, 33, 57, 112, 177, 71, 185, 23, 216, 135, 252, 66, 196, 243, 227, 111, 132, 211, 7, 203, 143, 155, 109, 232, 212, 40, 26, 154, 203, 65, 73, 140, 202, 235, 19, 32, 94, 143, 48, 223, 86, 44, 205, 108, 11, 117, 112, 198, 203, 45, 246, 229, 69, 237, 117, 88, 51, 188, 22, 99, 42, 24, 219, 174, 168, 155, 69, 203, 143, 118, 154, 219, 239, 147, 64, 220, 189, 27, 158, 3, 25, 107, 72, 189, 20, 182, 161, 168, 232, 90, 14, 208, 142, 208, 61, 173, 156, 33, 180, 153, 189, 220, 114, 128, 17, 151, 77, 57, 173, 56, 1, 2, 239, 20, 244, 222, 85, 130, 114, 64, 43, 185, 193, 74, 40, 61, 15, 65, 44, 126, 33, 171, 204, 41, 65, 252, 79, 104, 175, 117, 186, 25, 120, 172, 247, 22, 150, 186, 97, 164, 137, 55, 144, 113, 217, 211, 16, 217, 133, 250, 77, 65, 89, 105, 28, 94, 194, 127, 214, 32, 253, 131, 91, 123, 27, 255, 146, 81, 107, 178, 249, 174, 233, 19, 130, 92, 231, 250, 122, 144, 0, 224, 164, 209, 183, 205, 180, 210, 161, 7, 193, 198, 189, 122, 86, 121, 29, 211, 33, 52,
                253, 173, 140, 22, 34, 174, 229, 188, 83, 226, 154, 49, 115, 153, 105, 91, 15, 14, 173, 250, 193, 23, 174, 227, 17, 250, 224, 140, 84, 100, 102, 222, 19, 45, 50, 162, 242, 122, 108, 153, 70, 172, 102, 219, 220, 212, 173, 129, 200, 252, 225, 19, 92, 16, 147, 54, 37, 103, 52, 197, 57, 216, 63, 108, 246, 227, 52, 32, 84, 125, 42, 15, 78, 193, 33, 123, 220, 43, 213, 226, 126, 161, 145, 3, 11, 43, 14, 200, 48, 201, 117, 255, 20, 43, 188, 240, 133, 182, 95, 183, 160, 199, 14, 130, 43, 252, 240, 243, 87, 49, 47, 254, 223, 211, 113, 96, 202, 160, 64, 174, 196, 142, 108, 195, 76, 232, 59, 143, 188, 159, 50, 68, 177, 223, 215, 148, 221, 113, 117, 121, 159, 75, 153, 76, 31, 133, 3, 108, 165, 10, 115, 149, 158, 164, 217, 170, 232, 220, 186, 21, 181, 83, 214, 108, 33, 95, 205, 78, 72, 172, 57, 177, 143, 221, 154, 215, 217, 36, 39, 236, 190, 240, 143, 187, 93, 58, 7, 239, 176, 221, 48, 169, 25, 207, 240, 189, 50, 161, 236, 87, 137, 36, 155, 84, 160, 79, 13, 218, 65, 136, 101, 209, 7, 41, 194, 56, 76, 127, 236, 192, 154, 82,
                147, 110, 39, 104, 208, 195, 239, 177, 236, 92, 33, 237, 254, 83, 173, 52, 15, 34, 98, 85, 52, 192, 73, 59, 250, 28, 70, 128, 160, 236, 70, 236, 18, 143, 128, 187, 143, 165, 181, 144, 124, 64, 175, 63, 113, 245, 38, 146, 114, 130, 173, 94, 87, 101, 9, 162, 84, 174, 94, 237, 62, 53, 157, 211, 99, 102, 228, 68, 113, 94, 237, 45, 236, 172, 222, 10, 198, 104, 222, 212, 240, 32, 55, 43, 234, 54, 118, 184, 240, 16, 224, 26, 146, 204, 248, 205, 110, 134, 255, 154, 34, 38, 250, 156, 46, 203, 46, 211, 116, 220, 74, 73, 249, 167, 172, 65, 166, 166, 255, 147, 133, 66, 121, 134, 44, 45, 56, 122, 222, 54, 115, 182, 123, 110, 175, 44, 168, 133, 205, 13, 144, 114, 214, 235, 2, 93, 246, 134, 198, 233, 164, 134, 241, 254, 82, 58, 237, 179, 185, 134, 231, 201, 164, 28, 254, 12, 91, 28, 68, 243, 91, 235, 15, 200, 64, 165, 222, 36, 211, 135, 31, 250, 252, 84, 83, 49, 115, 47, 234, 53, 249, 55, 192, 106, 34, 74, 67, 206, 222, 33, 170, 127, 189, 252, 81, 203, 255, 250, 211, 41, 199, 185, 242, 1, 215, 24, 190, 98, 103, 126, 205, 13,
                203, 85, 144, 177, 159, 156, 35, 133, 85, 209, 2, 152, 55, 253, 82, 76, 25, 31, 161, 94, 154, 169, 255, 9, 148, 114, 231, 161, 236, 103, 25, 166, 118, 138, 220, 128, 224, 61, 143, 219, 85, 231, 231, 12, 227, 146, 200, 158, 112, 47, 92, 26, 207, 106, 124, 233, 160, 161, 224, 19, 113, 199, 186, 205, 237, 5, 172, 146, 128, 185, 168, 136, 89, 74, 149, 35, 173, 209, 72, 19, 122, 33, 254, 123, 132, 186, 188, 213, 142, 31, 176, 79, 255, 54, 68, 135, 240, 20, 40, 32, 210, 178, 241, 168, 233, 39, 35, 187, 5, 63, 27, 161, 61, 143, 91, 120, 8, 228, 184, 89, 175, 218, 213, 131, 66, 137, 36, 2, 93, 4, 22, 235, 181, 226, 210, 60, 99, 202, 158, 151, 191, 162, 131, 156, 17, 114, 206, 97, 99, 81, 169, 6, 66, 243, 228, 69, 156, 27, 155, 61, 209, 127, 140, 24, 232, 214, 0, 37, 208, 161, 36, 197, 155, 240, 156, 63, 210, 77, 15, 202, 115, 9, 4, 184, 110, 200, 144, 17, 82, 249, 253, 110, 149, 98, 92, 37, 63, 239, 165, 132, 144, 234, 243, 80, 108, 87, 30, 132, 132, 85, 241, 173, 118, 47, 104, 178, 35, 0, 252, 178, 223, 228, 134, 27,
                36, 195, 23, 183, 117, 250, 131, 209, 170, 163, 204, 78, 234, 177, 13, 77, 132, 27, 201, 40, 247, 129, 65, 70, 47, 220, 78, 66, 113, 223, 248, 55, 251, 65, 146, 96, 139, 144, 22, 9, 165, 212, 140, 173, 60, 193, 81, 203, 106, 175, 215, 120, 35, 186, 10, 82, 249, 112, 183, 252, 90, 125, 175, 8, 80, 55, 136, 246, 1, 42, 134, 106, 217, 182, 101, 125, 206, 53, 192, 143, 135, 239, 71, 159, 28, 107, 50, 124, 70, 150, 176, 188, 34, 81, 217, 219, 6, 148, 186, 204, 214, 65, 19, 89, 222, 10, 162, 78, 239, 138, 220, 3, 52, 16, 197, 127, 84, 105, 144, 34, 145, 103, 176, 199, 58, 6, 169, 8, 83, 235, 232, 181, 105, 146, 251, 162, 133, 127, 187, 213, 120, 56, 225, 38, 102, 12, 47, 168, 207, 102, 57, 48, 181, 230, 106, 106, 220, 56, 200, 31, 157, 80, 236, 60, 138, 130, 220, 187, 54, 230, 157, 146, 194, 143, 155, 14, 245, 40, 29, 152, 2, 87, 201, 131, 133, 150, 104, 74, 157, 69, 228, 151, 78, 52, 188, 89, 6, 114, 201, 149, 74, 95, 49, 157, 190, 246, 0, 62, 39, 52, 168, 179, 83, 64, 147, 155, 189, 201, 81, 34, 243, 204,89, 232,
                145, 234, 191, 173, 170, 242, 54, 72, 24, 166, 213, 130, 185, 115, 235, 84, 192, 4, 246, 162, 77, 47, 115, 23, 42, 145, 59, 123, 232, 227, 239, 58, 243, 114, 41, 252, 244, 39, 83, 74, 124, 140, 94, 237, 232, 129, 100, 9, 126, 78, 86, 194, 44, 253, 2, 132, 17, 68, 237, 4, 206, 121, 236, 253, 80, 118, 122, 106, 177, 80, 160, 60, 87, 18, 133, 2, 163, 176, 212, 9, 140, 230, 61, 212, 203, 97, 223, 213, 223, 240, 145, 201, 130, 253, 184, 232, 218, 5, 161, 201, 39, 126, 40, 97, 40, 41, 236, 6, 102, 240, 5, 234, 43, 168, 227, 231, 120, 92, 190, 248, 120, 136, 22, 125, 180, 216, 235, 199, 51, 46, 19, 219, 229, 81, 19, 147, 166, 107, 33, 30, 100, 193, 210, 230, 140, 50, 161, 242, 211, 236, 95, 134, 169, 235, 65, 154, 95, 159, 34, 225, 96, 224, 170, 182, 244, 169, 83, 106, 246, 182, 140, 108, 70, 70, 232, 39, 170, 240, 82, 131, 106, 6, 87, 58, 121, 102, 148, 188, 155, 40, 102, 245, 49, 54, 43, 37, 28, 163, 122, 242, 236, 202, 230, 137, 23, 7, 58, 236, 117, 122, 179, 6, 140, 222, 233, 16, 117, 3, 232, 228, 58, 115, 191,
                12, 66, 158, 111, 17, 157, 45, 63, 146, 86, 45, 64, 31, 86, 10, 75, 127, 62, 82, 82, 240, 38, 230, 227, 192, 193, 245, 74, 235, 163, 195, 80, 91, 212, 35, 216, 27, 73, 25, 151, 234, 130, 117, 168, 206, 216, 174, 120, 29, 72, 254, 2, 48, 192, 84, 249, 13, 45, 8, 94, 250, 47, 182, 98, 244, 247, 166, 149, 216, 253, 184, 127, 142, 246, 219, 201, 14, 227, 87, 6, 184, 191, 219, 180, 104, 150, 150, 150, 66, 94, 9, 244, 99, 133, 47, 61, 23, 200, 138, 247, 127, 241, 207, 117, 89, 59, 68, 108, 92, 9, 168, 118, 235, 179, 133, 191, 225, 180, 246, 55, 23, 174, 138, 93, 40, 93, 183, 185, 149, 234, 203, 200, 1, 188, 80, 250, 93, 2, 75, 144, 33, 23, 87, 130, 62, 58, 33, 139, 120, 95, 126, 38, 56, 14, 112, 128, 145, 60, 218, 200, 213, 20, 212, 227, 167, 141, 44, 15, 144, 199, 189, 148, 245, 150, 118, 238, 103, 114, 135, 233, 254, 57, 109, 253, 197, 171, 222, 135, 8, 238, 245, 217, 255, 55, 164, 224, 48, 11, 156, 142, 23, 162, 121, 214, 69, 185, 247, 57, 52, 241, 75, 25, 7, 92, 163, 44, 158, 178, 65, 240, 69, 229, 105, 231, 51,
                185, 230, 75, 73, 191, 125, 116, 196, 251, 174, 33, 104, 2, 251, 54, 48, 83, 161, 97, 57, 103, 25, 208, 238, 69, 236, 184, 69, 174, 192, 151, 171, 215, 119, 185, 249, 27, 164, 52, 25, 20, 150, 82, 145, 221, 45, 151, 15, 25, 109, 191, 226, 144, 74, 39, 78, 74, 39, 32, 234, 40, 121, 41, 129, 205, 64, 45, 225, 114, 227, 9, 120, 246, 190, 21, 209, 98, 44, 241, 213, 147, 196, 117, 29, 244, 227, 48, 213, 193, 212, 30, 185, 179, 139, 173, 165, 148, 201, 48, 149, 100, 122, 13, 99, 186, 69, 2, 170, 192, 13, 177, 72, 7, 191, 169, 66, 124, 190, 53, 195, 68, 202, 112, 67, 60, 185, 55, 95, 191, 76, 183, 81, 36, 16, 118, 59, 206, 94, 141, 65, 199, 208, 203, 86, 151, 135, 39, 180, 157, 164, 4, 17, 85, 146, 82, 60, 121, 238, 76, 33, 24, 87, 25, 37, 29, 173, 159, 51, 60, 228, 95, 103, 249, 155, 61, 89, 148, 179, 121, 109, 27, 219, 74, 57, 10, 152, 6, 227, 49, 26, 116, 77, 250, 178, 127, 70, 205, 0, 226, 223, 56, 120, 6, 161, 4, 62, 35, 111, 63, 235, 190, 79, 110, 17, 189, 36, 94, 213, 39, 53, 222, 252, 79, 86, 145, 29, 231,
                188, 70, 82, 64, 218, 175, 65, 128, 162, 74, 129, 141, 162, 72, 179, 42, 143, 102, 4, 158, 92, 146, 224, 38, 248, 226, 73, 177, 226, 84, 71, 249, 8, 101, 106, 234, 59, 215, 115, 36, 229, 146, 203, 123, 62, 100, 143, 104, 174, 158, 146, 95, 66, 190, 48, 100, 19, 74, 157, 1, 204, 184, 194, 130, 182, 231, 172, 19, 140, 40, 130, 2, 117, 58, 200, 109, 36, 167, 117, 24, 42, 43, 216, 198, 63, 255, 141, 219, 246, 178, 95, 121, 253, 161, 92, 138, 145, 18, 177, 250, 94, 2, 204, 81, 33, 109, 251, 9, 17, 188, 194, 58, 107, 126, 184, 168, 103, 85, 212, 55, 104, 152, 18, 53, 71, 22, 249, 104, 219, 95, 29, 81, 118, 233, 160, 99, 151, 94, 232, 149, 221, 181, 97, 67, 94, 26, 89, 89, 213, 10, 65, 108, 141, 23, 238, 46, 36, 159, 39, 97, 49, 110, 159, 147, 129, 4, 121, 155, 6, 170, 85, 86, 145, 121, 132, 139, 162, 166, 144, 238, 120, 220, 181, 3, 238, 245, 145, 177, 159, 72, 87, 78, 207, 249, 165, 249, 227, 40, 108, 195, 76, 234, 244, 125, 139, 176, 141, 185, 134, 81, 137, 62, 94, 104, 16, 206, 230, 237, 220, 79, 194, 9, 242, 37,
                201, 110, 55, 193, 162, 140, 132, 9, 38, 178, 236, 21, 61, 202, 153, 249, 79, 57, 95, 173, 105, 209, 155, 214, 41, 214, 62, 149, 246, 17, 51, 149, 11, 107, 250, 121, 21, 189, 231, 248, 49, 143, 159, 118, 201, 90, 109, 159, 125, 80, 192, 31, 171, 32, 239, 220, 154, 61, 221, 166, 60, 202, 197, 11, 200, 123, 252, 36, 136, 211, 207, 51, 223, 2, 194, 49, 183, 1, 99, 35, 230, 225, 77, 108, 149, 38, 227, 33, 224, 102, 20, 66, 240, 64, 208, 216, 174, 225, 112, 18, 153, 188, 248, 254, 145, 232, 55, 143, 65, 158, 77, 81, 209, 66, 172, 50, 48, 20, 119, 74, 242, 57, 6, 101, 7, 4, 225, 205, 255, 235, 71, 82, 180, 106, 30, 190, 146, 186, 82, 217, 59, 181, 138, 150, 61, 112, 154, 137, 106, 202, 37, 147, 160, 108, 64, 193, 225, 129, 241, 188, 182, 210, 11, 28, 164, 69, 248, 167, 139, 187, 37, 70, 209, 87, 243, 37, 61, 139, 10, 154, 174, 164, 173, 141, 142, 244, 254, 217, 149, 194, 84, 161, 248, 117, 130, 104, 119, 144, 77, 36, 170, 75, 18, 129, 15, 16, 147, 107, 219, 42, 43, 144, 155, 17, 39, 128, 78, 207, 231, 151, 36, 98,
                23, 84, 73, 55, 46, 166, 76, 88, 156, 143, 126, 61, 220, 92, 173, 210, 39, 153, 22, 216, 126, 206, 114, 127, 206, 178, 120, 29, 244, 29, 254, 145, 72, 10, 126, 87, 232, 138, 222, 127, 204, 76, 142, 53, 65, 29, 139, 213, 158, 150, 114, 214, 142, 38, 146, 203, 203, 89, 159, 211, 96, 41, 219, 28, 254, 248, 64, 232, 161, 68, 105, 228, 79, 22, 193, 198, 2, 65, 182, 150, 33, 78, 214, 243, 43, 255, 241, 16, 119, 145, 73, 60, 108, 71, 140, 123, 87, 25, 44, 160, 31, 36, 173, 20, 99, 81, 130, 246, 128, 157, 90, 198, 106, 13, 236, 64, 232, 98, 198, 101, 133, 234, 17, 140, 32, 35, 185, 166, 27, 182, 198, 227, 118, 99, 94, 59, 140, 17, 210, 18, 99, 185, 185, 44, 194, 8, 30, 80, 247, 32, 146, 253, 20, 138, 18, 170, 100, 175, 164, 236, 245, 107, 63, 167, 193, 165, 61, 84, 27, 157, 22, 18, 162, 49, 42, 26, 218, 152, 225, 131, 246, 63, 153, 116, 196, 58, 192, 24, 197, 154, 218, 110, 96, 127, 196, 246, 237, 233, 219, 190, 237, 249, 127, 148, 107, 147, 107, 237, 135, 132, 120, 72, 154, 124, 88, 174, 218, 72, 156, 42, 136, 237,
                74, 183, 208, 155, 193, 199, 29, 83, 62, 212, 21, 171, 186, 200, 202, 185, 32, 250, 20, 21, 51, 7, 80, 154, 17, 219, 86, 195, 61, 78, 4, 221, 240, 80, 198, 159, 127, 105, 89, 39, 165, 221, 66, 95, 85, 57, 7, 40, 79, 119, 36, 39, 64, 140, 197, 208, 198, 2, 30, 191, 134, 52, 246, 207, 62, 139, 243, 228, 99, 236, 76, 33, 107, 223, 231, 231, 35, 213, 132, 131, 140, 65, 195, 181, 175, 69, 130, 108, 180, 101, 48, 65, 32, 84, 17, 72, 3, 203, 152, 101, 176, 170, 124, 23, 36, 109, 188, 104, 176, 76, 220, 191, 78, 12, 150, 82, 220, 19, 141, 185, 156, 41, 116, 218, 108, 89, 118, 144, 104, 14, 41, 229, 12, 212, 203, 79, 93, 32, 232, 183, 168, 0, 137, 60, 62, 212, 19, 222, 83, 196, 35, 80, 188, 253, 116, 81, 31, 20, 235, 137, 39, 224, 202, 135, 244, 146
            };
            var objectID = new PdfObjectID(2, 0);
            byte[] key = { 175, 214, 98, 245, 105, 125, 123, 66, 34, 231, 219, 151, 232, 0, 91, 252 };

            var iv = new byte[16];
            Array.Copy(stream, iv, 16);

            var aesV2Security = new PdfAESV2SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);

            byte[] expected = { 113, 242, 77, 59, 208, 229, 249, 224, 156, 108, 169, 255, 240, 34, 101, 158 };
            Assert.AreEqual(expected, aesV2Security._key);

            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            byte[] bytes = new byte[stream.Length - 16];
            var length = aesV2Security.DecryptAES(stream, 16, stream.Length - 16, bytes);

            var xml = Encoding.UTF8.GetString(bytes, 0, length);
            Assert.IsTrue(xml.StartsWith("<?xpacket begin="));
            Assert.IsTrue(xml.Contains("W5M0MpCehiHzreSzNTczkc9d"));
            Assert.IsTrue(xml.EndsWith("?>"));
        }

        [Test(Description = "Encrypted Metadata")]
        public void EncryptMetadata_AESV3_R5()
        {
            byte[] stream =
            {
                60, 63, 120, 112, 97, 99, 107, 101, 116, 32, 98, 101, 103, 105, 110, 61, 34, 239, 187, 191, 34, 32, 105, 100, 61, 34, 87, 53, 77, 48, 77, 112, 67, 101, 104, 105, 72, 122, 114, 101, 83, 122, 78, 84, 99, 122, 107, 99, 57, 100, 34, 63, 62, 10, 60, 120, 58, 120, 109, 112, 109, 101, 116, 97, 32, 120, 109, 108, 110, 115, 58, 120, 61, 34, 97, 100, 111, 98, 101, 58, 110, 115, 58, 109, 101, 116, 97, 47, 34, 32, 120, 58, 120, 109, 112, 116, 107, 61, 34, 65, 100, 111, 98, 101, 32, 88, 77, 80, 32, 67, 111, 114, 101, 32, 52, 46, 50, 46, 49, 45, 99, 48, 52, 49, 32, 53, 50, 46, 51, 52, 50, 57, 57, 54, 44, 32, 50, 48, 48, 56, 47, 48, 53, 47, 48, 55, 45, 50, 49, 58, 51, 55, 58, 49, 57, 32, 32, 32, 32, 32, 32, 32, 32, 34, 62, 10, 32, 32, 32, 60, 114, 100, 102, 58, 82, 68, 70, 32, 120, 109, 108, 110, 115, 58, 114, 100, 102, 61, 34, 104, 116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 119, 51, 46, 111, 114, 103, 47, 49, 57, 57, 57, 47, 48, 50, 47, 50, 50, 45, 114, 100, 102, 45, 115, 121, 110, 116, 97, 120, 45, 110, 115, 35, 34, 62,
                10, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 120, 109, 112, 61, 34, 104, 116, 116, 112, 58, 47, 47, 110, 115, 46, 97, 100, 111, 98, 101, 46, 99, 111, 109, 47, 120, 97, 112, 47, 49, 46, 48, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 58, 77, 111, 100, 105, 102, 121, 68, 97, 116, 101, 62, 50, 48, 48, 57, 45, 48, 50, 45, 49, 53, 84, 49, 51, 58, 48, 51, 58, 49, 50, 45, 48, 56, 58, 48, 48, 60, 47, 120, 109, 112, 58, 77, 111, 100, 105, 102, 121, 68, 97, 116, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 58, 67, 114, 101, 97, 116, 101, 68, 97, 116, 101, 62, 50, 48, 48, 57, 45, 48, 50, 45, 49, 53, 84, 49, 51, 58, 48, 50, 58, 51, 53, 45, 48, 56, 58, 48, 48, 60, 47, 120, 109, 112, 58, 67, 114, 101, 97, 116, 101, 68, 97, 116, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60,
                120, 109, 112, 58, 77, 101, 116, 97, 100, 97, 116, 97, 68, 97, 116, 101, 62, 50, 48, 48, 57, 45, 48, 50, 45, 49, 53, 84, 49, 51, 58, 48, 51, 58, 49, 50, 45, 48, 56, 58, 48, 48, 60, 47, 120, 109, 112, 58, 77, 101, 116, 97, 100, 97, 116, 97, 68, 97, 116, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 58, 67, 114, 101, 97, 116, 111, 114, 84, 111, 111, 108, 62, 65, 99, 114, 111, 98, 97, 116, 32, 69, 100, 105, 116, 111, 114, 32, 57, 46, 48, 60, 47, 120, 109, 112, 58, 67, 114, 101, 97, 116, 111, 114, 84, 111, 111, 108, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62, 10, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 100, 99, 61, 34, 104, 116, 116, 112, 58, 47, 47, 112, 117, 114, 108, 46, 111, 114, 103, 47, 100, 99, 47, 101, 108, 101, 109,
                101, 110, 116, 115, 47, 49, 46, 49, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 100, 99, 58, 102, 111, 114, 109, 97, 116, 62, 97, 112, 112, 108, 105, 99, 97, 116, 105, 111, 110, 47, 112, 100, 102, 60, 47, 100, 99, 58, 102, 111, 114, 109, 97, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 100, 99, 58, 116, 105, 116, 108, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 65, 108, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 108, 105, 32, 120, 109, 108, 58, 108, 97, 110, 103, 61, 34, 120, 45, 100, 101, 102, 97, 117, 108, 116, 34, 62, 85, 110, 116, 105, 116, 108, 101, 100, 60, 47, 114, 100, 102, 58, 108, 105, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 65, 108, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 47, 100, 99, 58, 116, 105, 116, 108, 101, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62, 10, 32,
                32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 120, 109, 112, 77, 77, 61, 34, 104, 116, 116, 112, 58, 47, 47, 110, 115, 46, 97, 100, 111, 98, 101, 46, 99, 111, 109, 47, 120, 97, 112, 47, 49, 46, 48, 47, 109, 109, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 77, 77, 58, 68, 111, 99, 117, 109, 101, 110, 116, 73, 68, 62, 117, 117, 105, 100, 58, 57, 99, 49, 98, 98, 56, 57, 50, 45, 56, 50, 53, 52, 45, 101, 102, 52, 57, 45, 57, 100, 57, 51, 45, 48, 54, 52, 48, 50, 54, 51, 55, 53, 51, 50, 56, 60, 47, 120, 109, 112, 77, 77, 58, 68, 111, 99, 117, 109, 101, 110, 116, 73, 68, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 120, 109, 112, 77, 77, 58, 73, 110, 115, 116, 97, 110, 99, 101, 73, 68, 62, 117, 117, 105, 100, 58, 50, 51, 101, 53, 50, 48, 55, 100, 45, 57, 48, 48, 51, 45, 57, 49, 52, 48, 45, 98, 101, 53,
                54, 45, 50, 51, 55, 102, 52, 54, 101, 97, 98, 53, 100, 101, 60, 47, 120, 109, 112, 77, 77, 58, 73, 110, 115, 116, 97, 110, 99, 101, 73, 68, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62, 10, 32, 32, 32, 32, 32, 32, 60, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 114, 100, 102, 58, 97, 98, 111, 117, 116, 61, 34, 34, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 120, 109, 108, 110, 115, 58, 112, 100, 102, 61, 34, 104, 116, 116, 112, 58, 47, 47, 110, 115, 46, 97, 100, 111, 98, 101, 46, 99, 111, 109, 47, 112, 100, 102, 47, 49, 46, 51, 47, 34, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 112, 100, 102, 58, 80, 114, 111, 100, 117, 99, 101, 114, 62, 65, 100, 111, 98, 101, 32, 65, 99, 114, 111, 98, 97, 116, 32, 57, 46, 48, 46, 48, 60, 47, 112, 100, 102, 58, 80, 114, 111, 100, 117, 99, 101, 114, 62, 10, 32, 32, 32, 32, 32, 32, 60, 47, 114, 100, 102, 58, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 62,
                10, 32, 32, 32, 60, 47, 114, 100, 102, 58, 82, 68, 70, 62, 10, 60, 47, 120, 58, 120, 109, 112, 109, 101, 116, 97, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
                10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 60, 63, 120, 112, 97, 99, 107, 101, 116, 32, 101, 110, 100, 61, 34, 119, 34, 63, 62
            };
            byte[] expected =
            {
                222, 119, 34, 60, 88, 17, 111, 37, 188, 58, 229, 82, 179, 219, 175, 18, 17, 30, 209, 11, 38, 28, 154, 115, 190, 236, 9, 76, 248, 187, 192, 197, 45, 42, 59, 45, 14, 201, 31, 130, 174, 36, 90, 53, 78, 171, 241, 244, 184, 156, 174, 41, 155, 95, 9, 156, 253, 6, 124, 131, 122, 239, 255, 251, 112, 2, 186, 250, 197, 83, 43, 62, 147, 187, 230, 6, 98, 128, 11, 100, 218, 109, 91, 173, 66, 145, 90, 250, 202, 168, 233, 226, 19, 211, 175, 143, 35, 222, 82, 194, 153, 87, 183, 106, 16, 80, 203, 117, 238, 89, 153, 85, 94, 238, 111, 159, 225, 106, 218, 65, 241, 196, 13, 134, 0, 27, 98, 237, 96, 127, 192, 111, 63, 23, 131, 23, 37, 75, 144, 137, 175, 103, 231, 236, 175, 38, 209, 91, 35, 40, 110, 153, 73, 71, 156, 119, 218, 121, 12, 75, 228, 130, 147, 97, 68, 171, 42, 74, 191, 142, 143, 226, 87, 35, 231, 137, 121, 227, 105, 252, 123, 20, 159, 138, 71, 132, 96, 200, 224, 6, 77, 76, 179, 169, 201, 165, 118, 222, 104, 118, 76, 152, 41, 24, 234, 102, 221, 82, 86, 170, 9, 5, 107, 232, 225, 243, 98, 100, 79, 142, 116, 127, 70, 239, 74,
                204, 143, 52, 140, 247, 71, 171, 94, 68, 124, 122, 182, 103, 136, 88, 218, 189, 28, 211, 62, 13, 16, 112, 69, 174, 207, 229, 248, 241, 46, 247, 76, 106, 243, 245, 72, 134, 160, 235, 176, 43, 170, 18, 44, 37, 121, 142, 6, 226, 72, 252, 139, 211, 108, 38, 90, 183, 199, 160, 228, 139, 178, 125, 231, 194, 31, 122, 4, 133, 89, 13, 116, 249, 48, 126, 239, 59, 168, 28, 70, 234, 80, 1, 218, 98, 168, 40, 158, 118, 201, 241, 176, 44, 65, 175, 238, 160, 133, 133, 212, 160, 118, 65, 54, 211, 31, 186, 230, 115, 53, 143, 13, 19, 20, 89, 12, 79, 205, 141, 145, 216, 178, 132, 202, 54, 213, 32, 219, 95, 226, 230, 73, 60, 237, 30, 24, 192, 44, 183, 53, 154, 183, 159, 9, 222, 115, 157, 190, 79, 202, 216, 171, 35, 25, 144, 44, 13, 14, 216, 187, 239, 108, 42, 152, 132, 238, 180, 176, 220, 238, 78, 95, 21, 40, 68, 188, 188, 42, 183, 155, 217, 191, 122, 42, 153, 117, 122, 36, 98, 190, 128, 127, 3, 78, 120, 59, 205, 220, 64, 243, 92, 238, 74, 41, 211, 123, 49, 7, 100, 220, 32, 170, 194, 223, 167, 46, 193, 194, 232, 141, 201, 204, 135,
                149, 97, 140, 112, 194, 121, 100, 23, 26, 215, 244, 36, 77, 18, 44, 2, 175, 31, 168, 19, 46, 51, 242, 140, 100, 64, 129, 157, 168, 253, 69, 53, 23, 217, 204, 226, 4, 59, 71, 202, 0, 224, 6, 246, 12, 68, 19, 196, 15, 196, 106, 25, 30, 143, 133, 207, 51, 63, 50, 143, 141, 128, 9, 217, 79, 133, 57, 20, 120, 58, 118, 119, 246, 45, 74, 107, 102, 145, 210, 189, 164, 20, 61, 93, 248, 42, 7, 159, 229, 224, 90, 204, 73, 94, 135, 84, 185, 187, 163, 122, 170, 36, 14, 125, 67, 72, 187, 67, 144, 35, 145, 29, 52, 203, 75, 110, 219, 176, 224, 254, 22, 241, 67, 96, 175, 124, 120, 241, 103, 146, 227, 118, 9, 90, 19, 141, 51, 111, 47, 239, 126, 228, 218, 80, 141, 205, 236, 27, 238, 227, 173, 9, 217, 119, 234, 40, 83, 233, 181, 36, 25, 103, 59, 41, 27, 210, 87, 173, 166, 234, 204, 145, 81, 141, 194, 233, 65, 223, 188, 16, 124, 249, 184, 159, 154, 102, 87, 144, 57, 187, 10, 204, 74, 104, 23, 104, 182, 245, 167, 9, 23, 204, 60, 36, 226, 108, 5, 86, 240, 104, 215, 22, 31, 134, 209, 253, 79, 170, 156, 140, 139, 76, 107, 133, 219, 0,
                110, 101, 152, 65, 24, 157, 40, 62, 87, 78, 124, 196, 125, 214, 19, 184, 44, 42, 101, 232, 12, 165, 247, 189, 254, 57, 231, 29, 105, 144, 101, 181, 251, 155, 110, 238, 30, 252, 133, 186, 174, 17, 220, 22, 82, 219, 174, 55, 76, 102, 120, 145, 223, 1, 65, 178, 245, 0, 172, 69, 212, 111, 132, 72, 186, 23, 48, 0, 192, 181, 162, 71, 91, 163, 116, 243, 69, 184, 25, 131, 37, 172, 71, 192, 117, 163, 130, 204, 86, 115, 107, 237, 226, 139, 157, 17, 49, 94, 213, 223, 125, 179, 231, 178, 172, 148, 11, 57, 46, 140, 137, 13, 250, 91, 66, 41, 109, 143, 158, 30, 116, 103, 177, 33, 194, 200, 181, 13, 35, 47, 109, 23, 96, 139, 108, 232, 60, 35, 231, 66, 72, 20, 164, 92, 79, 70, 124, 253, 132, 43, 187, 201, 105, 202, 168, 108, 11, 140, 249, 223, 128, 22, 125, 129, 96, 18, 59, 252, 83, 112, 46, 36, 91, 160, 192, 245, 252, 37, 250, 26, 217, 88, 251, 110, 192, 222, 229, 63, 35, 63, 227, 90, 31, 189, 163, 197, 125, 162, 35, 248, 105, 55, 224, 225, 211, 209, 83, 66, 0, 192, 108, 209, 177, 184, 106, 188, 110, 202, 224, 180, 154, 116,
                159, 209, 222, 81, 30, 148, 210, 17, 253, 170, 97, 65, 78, 152, 33, 57, 112, 177, 71, 185, 23, 216, 135, 252, 66, 196, 243, 227, 111, 132, 211, 7, 203, 143, 155, 109, 232, 212, 40, 26, 154, 203, 65, 73, 140, 202, 235, 19, 32, 94, 143, 48, 223, 86, 44, 205, 108, 11, 117, 112, 198, 203, 45, 246, 229, 69, 237, 117, 88, 51, 188, 22, 99, 42, 24, 219, 174, 168, 155, 69, 203, 143, 118, 154, 219, 239, 147, 64, 220, 189, 27, 158, 3, 25, 107, 72, 189, 20, 182, 161, 168, 232, 90, 14, 208, 142, 208, 61, 173, 156, 33, 180, 153, 189, 220, 114, 128, 17, 151, 77, 57, 173, 56, 1, 2, 239, 20, 244, 222, 85, 130, 114, 64, 43, 185, 193, 74, 40, 61, 15, 65, 44, 126, 33, 171, 204, 41, 65, 252, 79, 104, 175, 117, 186, 25, 120, 172, 247, 22, 150, 186, 97, 164, 137, 55, 144, 113, 217, 211, 16, 217, 133, 250, 77, 65, 89, 105, 28, 94, 194, 127, 214, 32, 253, 131, 91, 123, 27, 255, 146, 81, 107, 178, 249, 174, 233, 19, 130, 92, 231, 250, 122, 144, 0, 224, 164, 209, 183, 205, 180, 210, 161, 7, 193, 198, 189, 122, 86, 121, 29, 211, 33, 52,
                253, 173, 140, 22, 34, 174, 229, 188, 83, 226, 154, 49, 115, 153, 105, 91, 15, 14, 173, 250, 193, 23, 174, 227, 17, 250, 224, 140, 84, 100, 102, 222, 19, 45, 50, 162, 242, 122, 108, 153, 70, 172, 102, 219, 220, 212, 173, 129, 200, 252, 225, 19, 92, 16, 147, 54, 37, 103, 52, 197, 57, 216, 63, 108, 246, 227, 52, 32, 84, 125, 42, 15, 78, 193, 33, 123, 220, 43, 213, 226, 126, 161, 145, 3, 11, 43, 14, 200, 48, 201, 117, 255, 20, 43, 188, 240, 133, 182, 95, 183, 160, 199, 14, 130, 43, 252, 240, 243, 87, 49, 47, 254, 223, 211, 113, 96, 202, 160, 64, 174, 196, 142, 108, 195, 76, 232, 59, 143, 188, 159, 50, 68, 177, 223, 215, 148, 221, 113, 117, 121, 159, 75, 153, 76, 31, 133, 3, 108, 165, 10, 115, 149, 158, 164, 217, 170, 232, 220, 186, 21, 181, 83, 214, 108, 33, 95, 205, 78, 72, 172, 57, 177, 143, 221, 154, 215, 217, 36, 39, 236, 190, 240, 143, 187, 93, 58, 7, 239, 176, 221, 48, 169, 25, 207, 240, 189, 50, 161, 236, 87, 137, 36, 155, 84, 160, 79, 13, 218, 65, 136, 101, 209, 7, 41, 194, 56, 76, 127, 236, 192, 154, 82,
                147, 110, 39, 104, 208, 195, 239, 177, 236, 92, 33, 237, 254, 83, 173, 52, 15, 34, 98, 85, 52, 192, 73, 59, 250, 28, 70, 128, 160, 236, 70, 236, 18, 143, 128, 187, 143, 165, 181, 144, 124, 64, 175, 63, 113, 245, 38, 146, 114, 130, 173, 94, 87, 101, 9, 162, 84, 174, 94, 237, 62, 53, 157, 211, 99, 102, 228, 68, 113, 94, 237, 45, 236, 172, 222, 10, 198, 104, 222, 212, 240, 32, 55, 43, 234, 54, 118, 184, 240, 16, 224, 26, 146, 204, 248, 205, 110, 134, 255, 154, 34, 38, 250, 156, 46, 203, 46, 211, 116, 220, 74, 73, 249, 167, 172, 65, 166, 166, 255, 147, 133, 66, 121, 134, 44, 45, 56, 122, 222, 54, 115, 182, 123, 110, 175, 44, 168, 133, 205, 13, 144, 114, 214, 235, 2, 93, 246, 134, 198, 233, 164, 134, 241, 254, 82, 58, 237, 179, 185, 134, 231, 201, 164, 28, 254, 12, 91, 28, 68, 243, 91, 235, 15, 200, 64, 165, 222, 36, 211, 135, 31, 250, 252, 84, 83, 49, 115, 47, 234, 53, 249, 55, 192, 106, 34, 74, 67, 206, 222, 33, 170, 127, 189, 252, 81, 203, 255, 250, 211, 41, 199, 185, 242, 1, 215, 24, 190, 98, 103, 126, 205, 13,
                203, 85, 144, 177, 159, 156, 35, 133, 85, 209, 2, 152, 55, 253, 82, 76, 25, 31, 161, 94, 154, 169, 255, 9, 148, 114, 231, 161, 236, 103, 25, 166, 118, 138, 220, 128, 224, 61, 143, 219, 85, 231, 231, 12, 227, 146, 200, 158, 112, 47, 92, 26, 207, 106, 124, 233, 160, 161, 224, 19, 113, 199, 186, 205, 237, 5, 172, 146, 128, 185, 168, 136, 89, 74, 149, 35, 173, 209, 72, 19, 122, 33, 254, 123, 132, 186, 188, 213, 142, 31, 176, 79, 255, 54, 68, 135, 240, 20, 40, 32, 210, 178, 241, 168, 233, 39, 35, 187, 5, 63, 27, 161, 61, 143, 91, 120, 8, 228, 184, 89, 175, 218, 213, 131, 66, 137, 36, 2, 93, 4, 22, 235, 181, 226, 210, 60, 99, 202, 158, 151, 191, 162, 131, 156, 17, 114, 206, 97, 99, 81, 169, 6, 66, 243, 228, 69, 156, 27, 155, 61, 209, 127, 140, 24, 232, 214, 0, 37, 208, 161, 36, 197, 155, 240, 156, 63, 210, 77, 15, 202, 115, 9, 4, 184, 110, 200, 144, 17, 82, 249, 253, 110, 149, 98, 92, 37, 63, 239, 165, 132, 144, 234, 243, 80, 108, 87, 30, 132, 132, 85, 241, 173, 118, 47, 104, 178, 35, 0, 252, 178, 223, 228, 134, 27,
                36, 195, 23, 183, 117, 250, 131, 209, 170, 163, 204, 78, 234, 177, 13, 77, 132, 27, 201, 40, 247, 129, 65, 70, 47, 220, 78, 66, 113, 223, 248, 55, 251, 65, 146, 96, 139, 144, 22, 9, 165, 212, 140, 173, 60, 193, 81, 203, 106, 175, 215, 120, 35, 186, 10, 82, 249, 112, 183, 252, 90, 125, 175, 8, 80, 55, 136, 246, 1, 42, 134, 106, 217, 182, 101, 125, 206, 53, 192, 143, 135, 239, 71, 159, 28, 107, 50, 124, 70, 150, 176, 188, 34, 81, 217, 219, 6, 148, 186, 204, 214, 65, 19, 89, 222, 10, 162, 78, 239, 138, 220, 3, 52, 16, 197, 127, 84, 105, 144, 34, 145, 103, 176, 199, 58, 6, 169, 8, 83, 235, 232, 181, 105, 146, 251, 162, 133, 127, 187, 213, 120, 56, 225, 38, 102, 12, 47, 168, 207, 102, 57, 48, 181, 230, 106, 106, 220, 56, 200, 31, 157, 80, 236, 60, 138, 130, 220, 187, 54, 230, 157, 146, 194, 143, 155, 14, 245, 40, 29, 152, 2, 87, 201, 131, 133, 150, 104, 74, 157, 69, 228, 151, 78, 52, 188, 89, 6, 114, 201, 149, 74, 95, 49, 157, 190, 246, 0, 62, 39, 52, 168, 179, 83, 64, 147, 155, 189, 201, 81, 34, 243, 204,89, 232,
                145, 234, 191, 173, 170, 242, 54, 72, 24, 166, 213, 130, 185, 115, 235, 84, 192, 4, 246, 162, 77, 47, 115, 23, 42, 145, 59, 123, 232, 227, 239, 58, 243, 114, 41, 252, 244, 39, 83, 74, 124, 140, 94, 237, 232, 129, 100, 9, 126, 78, 86, 194, 44, 253, 2, 132, 17, 68, 237, 4, 206, 121, 236, 253, 80, 118, 122, 106, 177, 80, 160, 60, 87, 18, 133, 2, 163, 176, 212, 9, 140, 230, 61, 212, 203, 97, 223, 213, 223, 240, 145, 201, 130, 253, 184, 232, 218, 5, 161, 201, 39, 126, 40, 97, 40, 41, 236, 6, 102, 240, 5, 234, 43, 168, 227, 231, 120, 92, 190, 248, 120, 136, 22, 125, 180, 216, 235, 199, 51, 46, 19, 219, 229, 81, 19, 147, 166, 107, 33, 30, 100, 193, 210, 230, 140, 50, 161, 242, 211, 236, 95, 134, 169, 235, 65, 154, 95, 159, 34, 225, 96, 224, 170, 182, 244, 169, 83, 106, 246, 182, 140, 108, 70, 70, 232, 39, 170, 240, 82, 131, 106, 6, 87, 58, 121, 102, 148, 188, 155, 40, 102, 245, 49, 54, 43, 37, 28, 163, 122, 242, 236, 202, 230, 137, 23, 7, 58, 236, 117, 122, 179, 6, 140, 222, 233, 16, 117, 3, 232, 228, 58, 115, 191,
                12, 66, 158, 111, 17, 157, 45, 63, 146, 86, 45, 64, 31, 86, 10, 75, 127, 62, 82, 82, 240, 38, 230, 227, 192, 193, 245, 74, 235, 163, 195, 80, 91, 212, 35, 216, 27, 73, 25, 151, 234, 130, 117, 168, 206, 216, 174, 120, 29, 72, 254, 2, 48, 192, 84, 249, 13, 45, 8, 94, 250, 47, 182, 98, 244, 247, 166, 149, 216, 253, 184, 127, 142, 246, 219, 201, 14, 227, 87, 6, 184, 191, 219, 180, 104, 150, 150, 150, 66, 94, 9, 244, 99, 133, 47, 61, 23, 200, 138, 247, 127, 241, 207, 117, 89, 59, 68, 108, 92, 9, 168, 118, 235, 179, 133, 191, 225, 180, 246, 55, 23, 174, 138, 93, 40, 93, 183, 185, 149, 234, 203, 200, 1, 188, 80, 250, 93, 2, 75, 144, 33, 23, 87, 130, 62, 58, 33, 139, 120, 95, 126, 38, 56, 14, 112, 128, 145, 60, 218, 200, 213, 20, 212, 227, 167, 141, 44, 15, 144, 199, 189, 148, 245, 150, 118, 238, 103, 114, 135, 233, 254, 57, 109, 253, 197, 171, 222, 135, 8, 238, 245, 217, 255, 55, 164, 224, 48, 11, 156, 142, 23, 162, 121, 214, 69, 185, 247, 57, 52, 241, 75, 25, 7, 92, 163, 44, 158, 178, 65, 240, 69, 229, 105, 231, 51,
                185, 230, 75, 73, 191, 125, 116, 196, 251, 174, 33, 104, 2, 251, 54, 48, 83, 161, 97, 57, 103, 25, 208, 238, 69, 236, 184, 69, 174, 192, 151, 171, 215, 119, 185, 249, 27, 164, 52, 25, 20, 150, 82, 145, 221, 45, 151, 15, 25, 109, 191, 226, 144, 74, 39, 78, 74, 39, 32, 234, 40, 121, 41, 129, 205, 64, 45, 225, 114, 227, 9, 120, 246, 190, 21, 209, 98, 44, 241, 213, 147, 196, 117, 29, 244, 227, 48, 213, 193, 212, 30, 185, 179, 139, 173, 165, 148, 201, 48, 149, 100, 122, 13, 99, 186, 69, 2, 170, 192, 13, 177, 72, 7, 191, 169, 66, 124, 190, 53, 195, 68, 202, 112, 67, 60, 185, 55, 95, 191, 76, 183, 81, 36, 16, 118, 59, 206, 94, 141, 65, 199, 208, 203, 86, 151, 135, 39, 180, 157, 164, 4, 17, 85, 146, 82, 60, 121, 238, 76, 33, 24, 87, 25, 37, 29, 173, 159, 51, 60, 228, 95, 103, 249, 155, 61, 89, 148, 179, 121, 109, 27, 219, 74, 57, 10, 152, 6, 227, 49, 26, 116, 77, 250, 178, 127, 70, 205, 0, 226, 223, 56, 120, 6, 161, 4, 62, 35, 111, 63, 235, 190, 79, 110, 17, 189, 36, 94, 213, 39, 53, 222, 252, 79, 86, 145, 29, 231,
                188, 70, 82, 64, 218, 175, 65, 128, 162, 74, 129, 141, 162, 72, 179, 42, 143, 102, 4, 158, 92, 146, 224, 38, 248, 226, 73, 177, 226, 84, 71, 249, 8, 101, 106, 234, 59, 215, 115, 36, 229, 146, 203, 123, 62, 100, 143, 104, 174, 158, 146, 95, 66, 190, 48, 100, 19, 74, 157, 1, 204, 184, 194, 130, 182, 231, 172, 19, 140, 40, 130, 2, 117, 58, 200, 109, 36, 167, 117, 24, 42, 43, 216, 198, 63, 255, 141, 219, 246, 178, 95, 121, 253, 161, 92, 138, 145, 18, 177, 250, 94, 2, 204, 81, 33, 109, 251, 9, 17, 188, 194, 58, 107, 126, 184, 168, 103, 85, 212, 55, 104, 152, 18, 53, 71, 22, 249, 104, 219, 95, 29, 81, 118, 233, 160, 99, 151, 94, 232, 149, 221, 181, 97, 67, 94, 26, 89, 89, 213, 10, 65, 108, 141, 23, 238, 46, 36, 159, 39, 97, 49, 110, 159, 147, 129, 4, 121, 155, 6, 170, 85, 86, 145, 121, 132, 139, 162, 166, 144, 238, 120, 220, 181, 3, 238, 245, 145, 177, 159, 72, 87, 78, 207, 249, 165, 249, 227, 40, 108, 195, 76, 234, 244, 125, 139, 176, 141, 185, 134, 81, 137, 62, 94, 104, 16, 206, 230, 237, 220, 79, 194, 9, 242, 37,
                201, 110, 55, 193, 162, 140, 132, 9, 38, 178, 236, 21, 61, 202, 153, 249, 79, 57, 95, 173, 105, 209, 155, 214, 41, 214, 62, 149, 246, 17, 51, 149, 11, 107, 250, 121, 21, 189, 231, 248, 49, 143, 159, 118, 201, 90, 109, 159, 125, 80, 192, 31, 171, 32, 239, 220, 154, 61, 221, 166, 60, 202, 197, 11, 200, 123, 252, 36, 136, 211, 207, 51, 223, 2, 194, 49, 183, 1, 99, 35, 230, 225, 77, 108, 149, 38, 227, 33, 224, 102, 20, 66, 240, 64, 208, 216, 174, 225, 112, 18, 153, 188, 248, 254, 145, 232, 55, 143, 65, 158, 77, 81, 209, 66, 172, 50, 48, 20, 119, 74, 242, 57, 6, 101, 7, 4, 225, 205, 255, 235, 71, 82, 180, 106, 30, 190, 146, 186, 82, 217, 59, 181, 138, 150, 61, 112, 154, 137, 106, 202, 37, 147, 160, 108, 64, 193, 225, 129, 241, 188, 182, 210, 11, 28, 164, 69, 248, 167, 139, 187, 37, 70, 209, 87, 243, 37, 61, 139, 10, 154, 174, 164, 173, 141, 142, 244, 254, 217, 149, 194, 84, 161, 248, 117, 130, 104, 119, 144, 77, 36, 170, 75, 18, 129, 15, 16, 147, 107, 219, 42, 43, 144, 155, 17, 39, 128, 78, 207, 231, 151, 36, 98,
                23, 84, 73, 55, 46, 166, 76, 88, 156, 143, 126, 61, 220, 92, 173, 210, 39, 153, 22, 216, 126, 206, 114, 127, 206, 178, 120, 29, 244, 29, 254, 145, 72, 10, 126, 87, 232, 138, 222, 127, 204, 76, 142, 53, 65, 29, 139, 213, 158, 150, 114, 214, 142, 38, 146, 203, 203, 89, 159, 211, 96, 41, 219, 28, 254, 248, 64, 232, 161, 68, 105, 228, 79, 22, 193, 198, 2, 65, 182, 150, 33, 78, 214, 243, 43, 255, 241, 16, 119, 145, 73, 60, 108, 71, 140, 123, 87, 25, 44, 160, 31, 36, 173, 20, 99, 81, 130, 246, 128, 157, 90, 198, 106, 13, 236, 64, 232, 98, 198, 101, 133, 234, 17, 140, 32, 35, 185, 166, 27, 182, 198, 227, 118, 99, 94, 59, 140, 17, 210, 18, 99, 185, 185, 44, 194, 8, 30, 80, 247, 32, 146, 253, 20, 138, 18, 170, 100, 175, 164, 236, 245, 107, 63, 167, 193, 165, 61, 84, 27, 157, 22, 18, 162, 49, 42, 26, 218, 152, 225, 131, 246, 63, 153, 116, 196, 58, 192, 24, 197, 154, 218, 110, 96, 127, 196, 246, 237, 233, 219, 190, 237, 249, 127, 148, 107, 147, 107, 237, 135, 132, 120, 72, 154, 124, 88, 174, 218, 72, 156, 42, 136, 237,
                74, 183, 208, 155, 193, 199, 29, 83, 62, 212, 21, 171, 186, 200, 202, 185, 32, 250, 20, 21, 51, 7, 80, 154, 17, 219, 86, 195, 61, 78, 4, 221, 240, 80, 198, 159, 127, 105, 89, 39, 165, 221, 66, 95, 85, 57, 7, 40, 79, 119, 36, 39, 64, 140, 197, 208, 198, 2, 30, 191, 134, 52, 246, 207, 62, 139, 243, 228, 99, 236, 76, 33, 107, 223, 231, 231, 35, 213, 132, 131, 140, 65, 195, 181, 175, 69, 130, 108, 180, 101, 48, 65, 32, 84, 17, 72, 3, 203, 152, 101, 176, 170, 124, 23, 36, 109, 188, 104, 176, 76, 220, 191, 78, 12, 150, 82, 220, 19, 141, 185, 156, 41, 116, 218, 108, 89, 118, 144, 104, 14, 41, 229, 12, 212, 203, 79, 93, 32, 232, 183, 168, 0, 137, 60, 62, 212, 19, 222, 83, 196, 35, 80, 188, 253, 116, 81, 31, 20, 235, 137, 39, 224, 202, 135, 244, 146
            };
            var objectID = new PdfObjectID(2, 0);
            byte[] key = { 9, 23, 125, 89, 49, 155, 162, 71, 252, 17, 199, 43, 240, 205, 17, 120, 183, 139, 21, 2, 151, 154, 54, 68, 250, 166, 139, 21, 230, 174, 171, 125 };
            byte[] iv = { 222, 119, 34, 60, 88, 17, 111, 37, 188, 58, 229, 82, 179, 219, 175, 18 };

            var xml = Encoding.UTF8.GetString(stream);
            Assert.IsTrue(xml.StartsWith("<?xpacket begin="));
            Assert.IsTrue(xml.Contains("W5M0MpCehiHzreSzNTczkc9d"));
            Assert.IsTrue(xml.EndsWith("?>"));

            var aesV2Security = new PdfAESV3SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);

            byte[] expectedKey = { 113, 242, 77, 59, 208, 229, 249, 224, 156, 108, 169, 255, 240, 34, 101, 158 };
            Assert.AreEqual(expectedKey, aesV2Security._key);

            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            var streamLength = stream.Length % 16 == 0 ? stream.Length : ((stream.Length / 16) + 1) * 16;
            var bytes = new byte[streamLength];
            var length = aesV2Security.EncryptAES(stream, 0, stream.Length, bytes);

            Assert.AreEqual(streamLength, length);

            var result = new byte[bytes.Length + 16];
            Array.Copy(iv, result, 16);
            Array.Copy(bytes, 0, result, 16, bytes.Length);

            Assert.AreEqual(expected, result);
        }

        [Test(Description = "Encrypted Metadata")]
        public void DecryptMetadata_AESV3_R5()
        {
            byte[] stream =
            {
                222, 119, 34, 60, 88, 17, 111, 37, 188, 58, 229, 82, 179, 219, 175, 18, 17, 30, 209, 11, 38, 28, 154, 115, 190, 236, 9, 76, 248, 187, 192, 197, 45, 42, 59, 45, 14, 201, 31, 130, 174, 36, 90, 53, 78, 171, 241, 244, 184, 156, 174, 41, 155, 95, 9, 156, 253, 6, 124, 131, 122, 239, 255, 251, 112, 2, 186, 250, 197, 83, 43, 62, 147, 187, 230, 6, 98, 128, 11, 100, 218, 109, 91, 173, 66, 145, 90, 250, 202, 168, 233, 226, 19, 211, 175, 143, 35, 222, 82, 194, 153, 87, 183, 106, 16, 80, 203, 117, 238, 89, 153, 85, 94, 238, 111, 159, 225, 106, 218, 65, 241, 196, 13, 134, 0, 27, 98, 237, 96, 127, 192, 111, 63, 23, 131, 23, 37, 75, 144, 137, 175, 103, 231, 236, 175, 38, 209, 91, 35, 40, 110, 153, 73, 71, 156, 119, 218, 121, 12, 75, 228, 130, 147, 97, 68, 171, 42, 74, 191, 142, 143, 226, 87, 35, 231, 137, 121, 227, 105, 252, 123, 20, 159, 138, 71, 132, 96, 200, 224, 6, 77, 76, 179, 169, 201, 165, 118, 222, 104, 118, 76, 152, 41, 24, 234, 102, 221, 82, 86, 170, 9, 5, 107, 232, 225, 243, 98, 100, 79, 142, 116, 127, 70, 239, 74,
                204, 143, 52, 140, 247, 71, 171, 94, 68, 124, 122, 182, 103, 136, 88, 218, 189, 28, 211, 62, 13, 16, 112, 69, 174, 207, 229, 248, 241, 46, 247, 76, 106, 243, 245, 72, 134, 160, 235, 176, 43, 170, 18, 44, 37, 121, 142, 6, 226, 72, 252, 139, 211, 108, 38, 90, 183, 199, 160, 228, 139, 178, 125, 231, 194, 31, 122, 4, 133, 89, 13, 116, 249, 48, 126, 239, 59, 168, 28, 70, 234, 80, 1, 218, 98, 168, 40, 158, 118, 201, 241, 176, 44, 65, 175, 238, 160, 133, 133, 212, 160, 118, 65, 54, 211, 31, 186, 230, 115, 53, 143, 13, 19, 20, 89, 12, 79, 205, 141, 145, 216, 178, 132, 202, 54, 213, 32, 219, 95, 226, 230, 73, 60, 237, 30, 24, 192, 44, 183, 53, 154, 183, 159, 9, 222, 115, 157, 190, 79, 202, 216, 171, 35, 25, 144, 44, 13, 14, 216, 187, 239, 108, 42, 152, 132, 238, 180, 176, 220, 238, 78, 95, 21, 40, 68, 188, 188, 42, 183, 155, 217, 191, 122, 42, 153, 117, 122, 36, 98, 190, 128, 127, 3, 78, 120, 59, 205, 220, 64, 243, 92, 238, 74, 41, 211, 123, 49, 7, 100, 220, 32, 170, 194, 223, 167, 46, 193, 194, 232, 141, 201, 204, 135,
                149, 97, 140, 112, 194, 121, 100, 23, 26, 215, 244, 36, 77, 18, 44, 2, 175, 31, 168, 19, 46, 51, 242, 140, 100, 64, 129, 157, 168, 253, 69, 53, 23, 217, 204, 226, 4, 59, 71, 202, 0, 224, 6, 246, 12, 68, 19, 196, 15, 196, 106, 25, 30, 143, 133, 207, 51, 63, 50, 143, 141, 128, 9, 217, 79, 133, 57, 20, 120, 58, 118, 119, 246, 45, 74, 107, 102, 145, 210, 189, 164, 20, 61, 93, 248, 42, 7, 159, 229, 224, 90, 204, 73, 94, 135, 84, 185, 187, 163, 122, 170, 36, 14, 125, 67, 72, 187, 67, 144, 35, 145, 29, 52, 203, 75, 110, 219, 176, 224, 254, 22, 241, 67, 96, 175, 124, 120, 241, 103, 146, 227, 118, 9, 90, 19, 141, 51, 111, 47, 239, 126, 228, 218, 80, 141, 205, 236, 27, 238, 227, 173, 9, 217, 119, 234, 40, 83, 233, 181, 36, 25, 103, 59, 41, 27, 210, 87, 173, 166, 234, 204, 145, 81, 141, 194, 233, 65, 223, 188, 16, 124, 249, 184, 159, 154, 102, 87, 144, 57, 187, 10, 204, 74, 104, 23, 104, 182, 245, 167, 9, 23, 204, 60, 36, 226, 108, 5, 86, 240, 104, 215, 22, 31, 134, 209, 253, 79, 170, 156, 140, 139, 76, 107, 133, 219, 0,
                110, 101, 152, 65, 24, 157, 40, 62, 87, 78, 124, 196, 125, 214, 19, 184, 44, 42, 101, 232, 12, 165, 247, 189, 254, 57, 231, 29, 105, 144, 101, 181, 251, 155, 110, 238, 30, 252, 133, 186, 174, 17, 220, 22, 82, 219, 174, 55, 76, 102, 120, 145, 223, 1, 65, 178, 245, 0, 172, 69, 212, 111, 132, 72, 186, 23, 48, 0, 192, 181, 162, 71, 91, 163, 116, 243, 69, 184, 25, 131, 37, 172, 71, 192, 117, 163, 130, 204, 86, 115, 107, 237, 226, 139, 157, 17, 49, 94, 213, 223, 125, 179, 231, 178, 172, 148, 11, 57, 46, 140, 137, 13, 250, 91, 66, 41, 109, 143, 158, 30, 116, 103, 177, 33, 194, 200, 181, 13, 35, 47, 109, 23, 96, 139, 108, 232, 60, 35, 231, 66, 72, 20, 164, 92, 79, 70, 124, 253, 132, 43, 187, 201, 105, 202, 168, 108, 11, 140, 249, 223, 128, 22, 125, 129, 96, 18, 59, 252, 83, 112, 46, 36, 91, 160, 192, 245, 252, 37, 250, 26, 217, 88, 251, 110, 192, 222, 229, 63, 35, 63, 227, 90, 31, 189, 163, 197, 125, 162, 35, 248, 105, 55, 224, 225, 211, 209, 83, 66, 0, 192, 108, 209, 177, 184, 106, 188, 110, 202, 224, 180, 154, 116,
                159, 209, 222, 81, 30, 148, 210, 17, 253, 170, 97, 65, 78, 152, 33, 57, 112, 177, 71, 185, 23, 216, 135, 252, 66, 196, 243, 227, 111, 132, 211, 7, 203, 143, 155, 109, 232, 212, 40, 26, 154, 203, 65, 73, 140, 202, 235, 19, 32, 94, 143, 48, 223, 86, 44, 205, 108, 11, 117, 112, 198, 203, 45, 246, 229, 69, 237, 117, 88, 51, 188, 22, 99, 42, 24, 219, 174, 168, 155, 69, 203, 143, 118, 154, 219, 239, 147, 64, 220, 189, 27, 158, 3, 25, 107, 72, 189, 20, 182, 161, 168, 232, 90, 14, 208, 142, 208, 61, 173, 156, 33, 180, 153, 189, 220, 114, 128, 17, 151, 77, 57, 173, 56, 1, 2, 239, 20, 244, 222, 85, 130, 114, 64, 43, 185, 193, 74, 40, 61, 15, 65, 44, 126, 33, 171, 204, 41, 65, 252, 79, 104, 175, 117, 186, 25, 120, 172, 247, 22, 150, 186, 97, 164, 137, 55, 144, 113, 217, 211, 16, 217, 133, 250, 77, 65, 89, 105, 28, 94, 194, 127, 214, 32, 253, 131, 91, 123, 27, 255, 146, 81, 107, 178, 249, 174, 233, 19, 130, 92, 231, 250, 122, 144, 0, 224, 164, 209, 183, 205, 180, 210, 161, 7, 193, 198, 189, 122, 86, 121, 29, 211, 33, 52,
                253, 173, 140, 22, 34, 174, 229, 188, 83, 226, 154, 49, 115, 153, 105, 91, 15, 14, 173, 250, 193, 23, 174, 227, 17, 250, 224, 140, 84, 100, 102, 222, 19, 45, 50, 162, 242, 122, 108, 153, 70, 172, 102, 219, 220, 212, 173, 129, 200, 252, 225, 19, 92, 16, 147, 54, 37, 103, 52, 197, 57, 216, 63, 108, 246, 227, 52, 32, 84, 125, 42, 15, 78, 193, 33, 123, 220, 43, 213, 226, 126, 161, 145, 3, 11, 43, 14, 200, 48, 201, 117, 255, 20, 43, 188, 240, 133, 182, 95, 183, 160, 199, 14, 130, 43, 252, 240, 243, 87, 49, 47, 254, 223, 211, 113, 96, 202, 160, 64, 174, 196, 142, 108, 195, 76, 232, 59, 143, 188, 159, 50, 68, 177, 223, 215, 148, 221, 113, 117, 121, 159, 75, 153, 76, 31, 133, 3, 108, 165, 10, 115, 149, 158, 164, 217, 170, 232, 220, 186, 21, 181, 83, 214, 108, 33, 95, 205, 78, 72, 172, 57, 177, 143, 221, 154, 215, 217, 36, 39, 236, 190, 240, 143, 187, 93, 58, 7, 239, 176, 221, 48, 169, 25, 207, 240, 189, 50, 161, 236, 87, 137, 36, 155, 84, 160, 79, 13, 218, 65, 136, 101, 209, 7, 41, 194, 56, 76, 127, 236, 192, 154, 82,
                147, 110, 39, 104, 208, 195, 239, 177, 236, 92, 33, 237, 254, 83, 173, 52, 15, 34, 98, 85, 52, 192, 73, 59, 250, 28, 70, 128, 160, 236, 70, 236, 18, 143, 128, 187, 143, 165, 181, 144, 124, 64, 175, 63, 113, 245, 38, 146, 114, 130, 173, 94, 87, 101, 9, 162, 84, 174, 94, 237, 62, 53, 157, 211, 99, 102, 228, 68, 113, 94, 237, 45, 236, 172, 222, 10, 198, 104, 222, 212, 240, 32, 55, 43, 234, 54, 118, 184, 240, 16, 224, 26, 146, 204, 248, 205, 110, 134, 255, 154, 34, 38, 250, 156, 46, 203, 46, 211, 116, 220, 74, 73, 249, 167, 172, 65, 166, 166, 255, 147, 133, 66, 121, 134, 44, 45, 56, 122, 222, 54, 115, 182, 123, 110, 175, 44, 168, 133, 205, 13, 144, 114, 214, 235, 2, 93, 246, 134, 198, 233, 164, 134, 241, 254, 82, 58, 237, 179, 185, 134, 231, 201, 164, 28, 254, 12, 91, 28, 68, 243, 91, 235, 15, 200, 64, 165, 222, 36, 211, 135, 31, 250, 252, 84, 83, 49, 115, 47, 234, 53, 249, 55, 192, 106, 34, 74, 67, 206, 222, 33, 170, 127, 189, 252, 81, 203, 255, 250, 211, 41, 199, 185, 242, 1, 215, 24, 190, 98, 103, 126, 205, 13,
                203, 85, 144, 177, 159, 156, 35, 133, 85, 209, 2, 152, 55, 253, 82, 76, 25, 31, 161, 94, 154, 169, 255, 9, 148, 114, 231, 161, 236, 103, 25, 166, 118, 138, 220, 128, 224, 61, 143, 219, 85, 231, 231, 12, 227, 146, 200, 158, 112, 47, 92, 26, 207, 106, 124, 233, 160, 161, 224, 19, 113, 199, 186, 205, 237, 5, 172, 146, 128, 185, 168, 136, 89, 74, 149, 35, 173, 209, 72, 19, 122, 33, 254, 123, 132, 186, 188, 213, 142, 31, 176, 79, 255, 54, 68, 135, 240, 20, 40, 32, 210, 178, 241, 168, 233, 39, 35, 187, 5, 63, 27, 161, 61, 143, 91, 120, 8, 228, 184, 89, 175, 218, 213, 131, 66, 137, 36, 2, 93, 4, 22, 235, 181, 226, 210, 60, 99, 202, 158, 151, 191, 162, 131, 156, 17, 114, 206, 97, 99, 81, 169, 6, 66, 243, 228, 69, 156, 27, 155, 61, 209, 127, 140, 24, 232, 214, 0, 37, 208, 161, 36, 197, 155, 240, 156, 63, 210, 77, 15, 202, 115, 9, 4, 184, 110, 200, 144, 17, 82, 249, 253, 110, 149, 98, 92, 37, 63, 239, 165, 132, 144, 234, 243, 80, 108, 87, 30, 132, 132, 85, 241, 173, 118, 47, 104, 178, 35, 0, 252, 178, 223, 228, 134, 27,
                36, 195, 23, 183, 117, 250, 131, 209, 170, 163, 204, 78, 234, 177, 13, 77, 132, 27, 201, 40, 247, 129, 65, 70, 47, 220, 78, 66, 113, 223, 248, 55, 251, 65, 146, 96, 139, 144, 22, 9, 165, 212, 140, 173, 60, 193, 81, 203, 106, 175, 215, 120, 35, 186, 10, 82, 249, 112, 183, 252, 90, 125, 175, 8, 80, 55, 136, 246, 1, 42, 134, 106, 217, 182, 101, 125, 206, 53, 192, 143, 135, 239, 71, 159, 28, 107, 50, 124, 70, 150, 176, 188, 34, 81, 217, 219, 6, 148, 186, 204, 214, 65, 19, 89, 222, 10, 162, 78, 239, 138, 220, 3, 52, 16, 197, 127, 84, 105, 144, 34, 145, 103, 176, 199, 58, 6, 169, 8, 83, 235, 232, 181, 105, 146, 251, 162, 133, 127, 187, 213, 120, 56, 225, 38, 102, 12, 47, 168, 207, 102, 57, 48, 181, 230, 106, 106, 220, 56, 200, 31, 157, 80, 236, 60, 138, 130, 220, 187, 54, 230, 157, 146, 194, 143, 155, 14, 245, 40, 29, 152, 2, 87, 201, 131, 133, 150, 104, 74, 157, 69, 228, 151, 78, 52, 188, 89, 6, 114, 201, 149, 74, 95, 49, 157, 190, 246, 0, 62, 39, 52, 168, 179, 83, 64, 147, 155, 189, 201, 81, 34, 243, 204,89, 232,
                145, 234, 191, 173, 170, 242, 54, 72, 24, 166, 213, 130, 185, 115, 235, 84, 192, 4, 246, 162, 77, 47, 115, 23, 42, 145, 59, 123, 232, 227, 239, 58, 243, 114, 41, 252, 244, 39, 83, 74, 124, 140, 94, 237, 232, 129, 100, 9, 126, 78, 86, 194, 44, 253, 2, 132, 17, 68, 237, 4, 206, 121, 236, 253, 80, 118, 122, 106, 177, 80, 160, 60, 87, 18, 133, 2, 163, 176, 212, 9, 140, 230, 61, 212, 203, 97, 223, 213, 223, 240, 145, 201, 130, 253, 184, 232, 218, 5, 161, 201, 39, 126, 40, 97, 40, 41, 236, 6, 102, 240, 5, 234, 43, 168, 227, 231, 120, 92, 190, 248, 120, 136, 22, 125, 180, 216, 235, 199, 51, 46, 19, 219, 229, 81, 19, 147, 166, 107, 33, 30, 100, 193, 210, 230, 140, 50, 161, 242, 211, 236, 95, 134, 169, 235, 65, 154, 95, 159, 34, 225, 96, 224, 170, 182, 244, 169, 83, 106, 246, 182, 140, 108, 70, 70, 232, 39, 170, 240, 82, 131, 106, 6, 87, 58, 121, 102, 148, 188, 155, 40, 102, 245, 49, 54, 43, 37, 28, 163, 122, 242, 236, 202, 230, 137, 23, 7, 58, 236, 117, 122, 179, 6, 140, 222, 233, 16, 117, 3, 232, 228, 58, 115, 191,
                12, 66, 158, 111, 17, 157, 45, 63, 146, 86, 45, 64, 31, 86, 10, 75, 127, 62, 82, 82, 240, 38, 230, 227, 192, 193, 245, 74, 235, 163, 195, 80, 91, 212, 35, 216, 27, 73, 25, 151, 234, 130, 117, 168, 206, 216, 174, 120, 29, 72, 254, 2, 48, 192, 84, 249, 13, 45, 8, 94, 250, 47, 182, 98, 244, 247, 166, 149, 216, 253, 184, 127, 142, 246, 219, 201, 14, 227, 87, 6, 184, 191, 219, 180, 104, 150, 150, 150, 66, 94, 9, 244, 99, 133, 47, 61, 23, 200, 138, 247, 127, 241, 207, 117, 89, 59, 68, 108, 92, 9, 168, 118, 235, 179, 133, 191, 225, 180, 246, 55, 23, 174, 138, 93, 40, 93, 183, 185, 149, 234, 203, 200, 1, 188, 80, 250, 93, 2, 75, 144, 33, 23, 87, 130, 62, 58, 33, 139, 120, 95, 126, 38, 56, 14, 112, 128, 145, 60, 218, 200, 213, 20, 212, 227, 167, 141, 44, 15, 144, 199, 189, 148, 245, 150, 118, 238, 103, 114, 135, 233, 254, 57, 109, 253, 197, 171, 222, 135, 8, 238, 245, 217, 255, 55, 164, 224, 48, 11, 156, 142, 23, 162, 121, 214, 69, 185, 247, 57, 52, 241, 75, 25, 7, 92, 163, 44, 158, 178, 65, 240, 69, 229, 105, 231, 51,
                185, 230, 75, 73, 191, 125, 116, 196, 251, 174, 33, 104, 2, 251, 54, 48, 83, 161, 97, 57, 103, 25, 208, 238, 69, 236, 184, 69, 174, 192, 151, 171, 215, 119, 185, 249, 27, 164, 52, 25, 20, 150, 82, 145, 221, 45, 151, 15, 25, 109, 191, 226, 144, 74, 39, 78, 74, 39, 32, 234, 40, 121, 41, 129, 205, 64, 45, 225, 114, 227, 9, 120, 246, 190, 21, 209, 98, 44, 241, 213, 147, 196, 117, 29, 244, 227, 48, 213, 193, 212, 30, 185, 179, 139, 173, 165, 148, 201, 48, 149, 100, 122, 13, 99, 186, 69, 2, 170, 192, 13, 177, 72, 7, 191, 169, 66, 124, 190, 53, 195, 68, 202, 112, 67, 60, 185, 55, 95, 191, 76, 183, 81, 36, 16, 118, 59, 206, 94, 141, 65, 199, 208, 203, 86, 151, 135, 39, 180, 157, 164, 4, 17, 85, 146, 82, 60, 121, 238, 76, 33, 24, 87, 25, 37, 29, 173, 159, 51, 60, 228, 95, 103, 249, 155, 61, 89, 148, 179, 121, 109, 27, 219, 74, 57, 10, 152, 6, 227, 49, 26, 116, 77, 250, 178, 127, 70, 205, 0, 226, 223, 56, 120, 6, 161, 4, 62, 35, 111, 63, 235, 190, 79, 110, 17, 189, 36, 94, 213, 39, 53, 222, 252, 79, 86, 145, 29, 231,
                188, 70, 82, 64, 218, 175, 65, 128, 162, 74, 129, 141, 162, 72, 179, 42, 143, 102, 4, 158, 92, 146, 224, 38, 248, 226, 73, 177, 226, 84, 71, 249, 8, 101, 106, 234, 59, 215, 115, 36, 229, 146, 203, 123, 62, 100, 143, 104, 174, 158, 146, 95, 66, 190, 48, 100, 19, 74, 157, 1, 204, 184, 194, 130, 182, 231, 172, 19, 140, 40, 130, 2, 117, 58, 200, 109, 36, 167, 117, 24, 42, 43, 216, 198, 63, 255, 141, 219, 246, 178, 95, 121, 253, 161, 92, 138, 145, 18, 177, 250, 94, 2, 204, 81, 33, 109, 251, 9, 17, 188, 194, 58, 107, 126, 184, 168, 103, 85, 212, 55, 104, 152, 18, 53, 71, 22, 249, 104, 219, 95, 29, 81, 118, 233, 160, 99, 151, 94, 232, 149, 221, 181, 97, 67, 94, 26, 89, 89, 213, 10, 65, 108, 141, 23, 238, 46, 36, 159, 39, 97, 49, 110, 159, 147, 129, 4, 121, 155, 6, 170, 85, 86, 145, 121, 132, 139, 162, 166, 144, 238, 120, 220, 181, 3, 238, 245, 145, 177, 159, 72, 87, 78, 207, 249, 165, 249, 227, 40, 108, 195, 76, 234, 244, 125, 139, 176, 141, 185, 134, 81, 137, 62, 94, 104, 16, 206, 230, 237, 220, 79, 194, 9, 242, 37,
                201, 110, 55, 193, 162, 140, 132, 9, 38, 178, 236, 21, 61, 202, 153, 249, 79, 57, 95, 173, 105, 209, 155, 214, 41, 214, 62, 149, 246, 17, 51, 149, 11, 107, 250, 121, 21, 189, 231, 248, 49, 143, 159, 118, 201, 90, 109, 159, 125, 80, 192, 31, 171, 32, 239, 220, 154, 61, 221, 166, 60, 202, 197, 11, 200, 123, 252, 36, 136, 211, 207, 51, 223, 2, 194, 49, 183, 1, 99, 35, 230, 225, 77, 108, 149, 38, 227, 33, 224, 102, 20, 66, 240, 64, 208, 216, 174, 225, 112, 18, 153, 188, 248, 254, 145, 232, 55, 143, 65, 158, 77, 81, 209, 66, 172, 50, 48, 20, 119, 74, 242, 57, 6, 101, 7, 4, 225, 205, 255, 235, 71, 82, 180, 106, 30, 190, 146, 186, 82, 217, 59, 181, 138, 150, 61, 112, 154, 137, 106, 202, 37, 147, 160, 108, 64, 193, 225, 129, 241, 188, 182, 210, 11, 28, 164, 69, 248, 167, 139, 187, 37, 70, 209, 87, 243, 37, 61, 139, 10, 154, 174, 164, 173, 141, 142, 244, 254, 217, 149, 194, 84, 161, 248, 117, 130, 104, 119, 144, 77, 36, 170, 75, 18, 129, 15, 16, 147, 107, 219, 42, 43, 144, 155, 17, 39, 128, 78, 207, 231, 151, 36, 98,
                23, 84, 73, 55, 46, 166, 76, 88, 156, 143, 126, 61, 220, 92, 173, 210, 39, 153, 22, 216, 126, 206, 114, 127, 206, 178, 120, 29, 244, 29, 254, 145, 72, 10, 126, 87, 232, 138, 222, 127, 204, 76, 142, 53, 65, 29, 139, 213, 158, 150, 114, 214, 142, 38, 146, 203, 203, 89, 159, 211, 96, 41, 219, 28, 254, 248, 64, 232, 161, 68, 105, 228, 79, 22, 193, 198, 2, 65, 182, 150, 33, 78, 214, 243, 43, 255, 241, 16, 119, 145, 73, 60, 108, 71, 140, 123, 87, 25, 44, 160, 31, 36, 173, 20, 99, 81, 130, 246, 128, 157, 90, 198, 106, 13, 236, 64, 232, 98, 198, 101, 133, 234, 17, 140, 32, 35, 185, 166, 27, 182, 198, 227, 118, 99, 94, 59, 140, 17, 210, 18, 99, 185, 185, 44, 194, 8, 30, 80, 247, 32, 146, 253, 20, 138, 18, 170, 100, 175, 164, 236, 245, 107, 63, 167, 193, 165, 61, 84, 27, 157, 22, 18, 162, 49, 42, 26, 218, 152, 225, 131, 246, 63, 153, 116, 196, 58, 192, 24, 197, 154, 218, 110, 96, 127, 196, 246, 237, 233, 219, 190, 237, 249, 127, 148, 107, 147, 107, 237, 135, 132, 120, 72, 154, 124, 88, 174, 218, 72, 156, 42, 136, 237,
                74, 183, 208, 155, 193, 199, 29, 83, 62, 212, 21, 171, 186, 200, 202, 185, 32, 250, 20, 21, 51, 7, 80, 154, 17, 219, 86, 195, 61, 78, 4, 221, 240, 80, 198, 159, 127, 105, 89, 39, 165, 221, 66, 95, 85, 57, 7, 40, 79, 119, 36, 39, 64, 140, 197, 208, 198, 2, 30, 191, 134, 52, 246, 207, 62, 139, 243, 228, 99, 236, 76, 33, 107, 223, 231, 231, 35, 213, 132, 131, 140, 65, 195, 181, 175, 69, 130, 108, 180, 101, 48, 65, 32, 84, 17, 72, 3, 203, 152, 101, 176, 170, 124, 23, 36, 109, 188, 104, 176, 76, 220, 191, 78, 12, 150, 82, 220, 19, 141, 185, 156, 41, 116, 218, 108, 89, 118, 144, 104, 14, 41, 229, 12, 212, 203, 79, 93, 32, 232, 183, 168, 0, 137, 60, 62, 212, 19, 222, 83, 196, 35, 80, 188, 253, 116, 81, 31, 20, 235, 137, 39, 224, 202, 135, 244, 146
            };
            var objectID = new PdfObjectID(2, 0);
            byte[] key = { 9, 23, 125, 89, 49, 155, 162, 71, 252, 17, 199, 43, 240, 205, 17, 120, 183, 139, 21, 2, 151, 154, 54, 68, 250, 166, 139, 21, 230, 174, 171, 125 };

            var iv = new byte[16];
            Array.Copy(stream, iv, 16);

            var aesV2Security = new PdfAESV3SecurityHandler(new PdfDictionary())
            {
                _encryptionKey = key
            };

            aesV2Security.SetHashKey(objectID);

            byte[] expected = { 113, 242, 77, 59, 208, 229, 249, 224, 156, 108, 169, 255, 240, 34, 101, 158 };
            Assert.AreEqual(expected, aesV2Security._key);

            aesV2Security.PrepareAESKey();
            aesV2Security.PrepareAESIV(iv);

            byte[] bytes = new byte[stream.Length - 16];
            var length = aesV2Security.DecryptAES(stream, 16, stream.Length - 16, bytes);

            var xml = Encoding.UTF8.GetString(bytes, 0, length);
            Assert.IsTrue(xml.StartsWith("<?xpacket begin="));
            Assert.IsTrue(xml.Contains("W5M0MpCehiHzreSzNTczkc9d"));
            Assert.IsTrue(xml.EndsWith("?>"));
        }
    }
}
